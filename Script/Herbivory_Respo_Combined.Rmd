---
title: "Herbivory and Respo Updated"
author: "Robert Dellinger"
date: "2023-01-27"
output:
  pdf_document: default
  html_document: default
---

#Load Library 

```{r, message=FALSE}

library(devtools)
library(performance)
library(see)
library(here)
library(tidyverse)
library(lubridate)
library(psych)
library(ggpubr)
library(ggpmisc)
library(LoLinR)
library(rTPC)
library(dplyr)
library(boot)
library(car)
library(chron)
library(patchwork)
library(stringr)
library(PNWColors)
library(gridExtra)
library(nls.multstart)
library(broom)
library(ggrepel)
library(segmented)
library(plotrix)
library(imputeTS)
library(MuMIn)
library(gt)
library(gtExtras)
library(ggimage)
library(seacarb)
library(broom)

```

# Load In Data 

```{r Loading in Treatment Data, message=FALSE}

#### SNAIL DATA #### 
treatment.metadata <- read_csv(here::here("Data", "Snail_Metadata","Treatment_Organism_ID_Information.csv"))
#treatment.metadata  %>% view()

snail.data <- read_csv(here::here("Data", "Snail_Metadata","Snail_Morphometric_Data.csv"))
#treatment.metadata  %>% view()
snail.data <- snail.data %>% mutate(Snail_ID=as.character(Snail_ID))
  
snail.treatment <- left_join(treatment.metadata, snail.data)

```

#ENVIRONMENTAL DATA SCRIPT

```{r}

#reading in mesocosm treatment metadata
mesocosm.metadata <- read_csv(here("Data", "Mesocosm_Data", "Mesocosm_Metadata.csv"))

#reading in mesocosm in situ measurements for normalization 
mesocosm.data <- read_csv(here::here("Data", "Mesocosm_Data", "Mesocosm_Daily_Datasheet.csv"))

ph.data <- read_csv(here::here('Data/Mesocosm_Data/Mesocosm_pH/pHTotal.csv'))
```
```{r}

# Calculating mean, variance, and standard deviation for each variable
summary_stats <- ph.data %>%
  group_by(SampleID) %>%
  summarize(
    mean_Salinity = mean(Salinity_lab),
    var_Salinity = var(Salinity_lab),
    sd_Salinity = sd(Salinity_lab),
    mean_pH = mean(pH),
    var_pH = var(pH),
    sd_pH = sd(pH),
    mean_Temp = mean(TempInSitu),
    var_Temp = var(TempInSitu),
    sd_Temp = sd(TempInSitu)
  ) %>%
  filter(grepl("^\\d+$", SampleID)) %>%
  pivot_longer(
    cols = -SampleID,
    names_to = "Variable",
    values_to = "Value"
  ) %>%
  separate(Variable, into = c("Statistic", "Variable"), sep = "_", remove = FALSE) %>%
  pivot_wider(
    names_from = Statistic,
    values_from = Value
  )

# Renaming the columns for the scientific paper
summary_stats <- summary_stats %>%
  rename(
    "Mean" = mean,
    "Standard Deviation" = sd,
    "Variance" = var
  )

# Renaming the SampleID column to Tank ID
summary_stats <- summary_stats %>%
  rename("Tank_ID" = SampleID) %>%
  mutate(`Tank_ID` = paste0("Tank_", `Tank_ID`))

# Printing the summary statistics
print(summary_stats)

# Filtering summary_stats for pH data only
pH_summary <- summary_stats %>% 
  filter(Variable == "pH")

treatment <- snail.treatment %>% 
  select(Tank_ID, Temp_Treatment, pH_Treatment)

pH_Treatment <- left_join(treatment, pH_summary, by="Tank_ID")

ggplot(pH_Treatment, aes(x = Temp_Treatment, y = Mean, group = Tank_ID, color = factor(pH_Treatment))) +
  geom_point(size = 2) +
  geom_errorbar(aes(ymin = Mean - `Standard Deviation`, ymax = Mean + `Standard Deviation`), width = 0.5, color = "black") +
  geom_hline(yintercept = c(7.7, 8.0), linetype = "dashed", color = c("orange", "cyan3")) +
  theme_bw() +
  labs(x = "Temperature Treatment", y = "pH", color = "pH Treatment") +
  scale_color_manual(values = c("orange", "cyan3")) +
  theme(
    text = element_text(family = "Arial", size = 10),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank(),
    axis.line = element_line(),
    legend.position = "right"  # Move the legend to the right-hand side
  ) +
  ggtitle("Mesocosm pH Values") +
  theme(plot.title = element_text(size = 16, face = "bold", hjust = 0.5)) +
  guides(color = guide_legend(title = "pH Treatment")) +
  scale_x_continuous(expand = expansion(mult = c(0.05, 0.05))) +
  scale_y_continuous(expand = expansion(mult = c(0.05, 0.05)))


```



# Data Wrangling Mesocosm Temperature

```{r, warning=FALSE, echo=FALSE}

#selecting all files from the folders
files <- list.files(here("Data","Mesocosm_Data","Mesocosm_HOBO_Temperature"),
                    pattern = ".csv", full.names = TRUE) %>% 
  sort(decreasing = TRUE) #files ordered by decreasing values

#reading in temperature data
temp.data <- files %>%  # read csv files into one data frame
  set_names() %>% #set names of file as column
  map_dfr(~ read_csv(.x, skip=4, col_names = c("Date", "Temp"), col_types = list(col_character(), col_double())), .id="filename") %>% #skip metadata
  mutate(Tank_ID= str_extract(filename, pattern = regex("TNK-[0-9]+|TNK-[A-Z]{3}")), #string extract 
         Tank_ID= str_replace(Tank_ID, pattern="-", replacement="_"), #replace pattern 
         Date=ymd_hms(Date), #change to date format
         Time = hms(format(Date, format = "%H:%M:%S"))) %>%  #separate date and time columns 
  select(Tank_ID, Date, Time, Temp) #selecting columns 
  
#cleaning and filtering data
temp.clean <- temp.data %>% 
  mutate(Tide = ifelse(Time > hms("12:00:00") & Time < hms("18:00:00") | 
                       Time > hms("00:00:00") & Time < hms("06:00:00"),
                       "Low","High")) %>% # tide columns
  filter(Date >= "2022-08-16",
         Date <= "2022-09-02") %>% #filtering for length of the experiment
  group_by(Tank_ID) %>% #group by Tank_ID
  na.omit() %>% 
  left_join(mesocosm.metadata)

ggplot(temp.clean, aes(y=Temp, x=Date)) +
  geom_point(aes(color = Tide), na.rm=TRUE) +
  geom_hline(aes(yintercept = Temp_Treatment)) +
  facet_wrap(~Tank_ID) +
  scale_color_discrete(name="Tank") +
  theme_bw() +
  theme(text=element_text(family="Helvetica", size = 5, color = 'black'),
        legend.title = element_text(size=10)) +
    scale_y_continuous(breaks = c(12,14,16,18,20,22,24,26,28,30,32))+
  labs(title="Mesocosm Temperature Range") +
  xlab("Date") +
  ylab("Temperature (°C)")

#selecting temperatures for temperature at low tide (air temperature)
air.temperature <- temp.clean %>% #select times for air exposure
  filter(Time > hms("13:00:00") & Time < hms("17:00:00") |
           Time > hms("01:00:00") & Time < hms("05:00:00")) 

ggplot(air.temperature, aes(y=Temp, X=factor(Temp_Treatment), color=Tank_ID))+
  geom_boxplot()+
  theme_bw()+
  theme(text=element_text(family="Helvetica", size = 5, color = 'black'),
        legend.title = element_text(size=10))+
    scale_y_continuous(breaks = c(12,14,16,18,20,22,24,26))+
  labs(title="Mesocosm Temperature Range (Air)")+
  xlab("Temperature Treatment")+
  ylab("Temperature (°C)")

#selecting temperatures for temperature at high tide (water temperature)
water.temperature <- temp.clean %>%
  filter(Time > hms("07:00:00") & Time < hms("11:00:00") |
          Time > hms("19:00:00") & Time < hms("23:00:00"))

ggplot(water.temperature, aes(y=Temp, X=factor(Temp_Treatment), color=Tank_ID))+
  geom_boxplot()+
  theme_bw()+
  theme(text=element_text(family="Helvetica", size = 5, color = 'black'),
        legend.title = element_text(size=10))+
    scale_y_continuous(breaks = c(12,14,16,18,20,22,24,26))+
  labs(title="Mesocosm Temperature Range (Seawater)")+
  xlab("Temperature Treatment")+
  ylab("Temperature (°C)")

```

# Plotting High Tide Water Temperatures

```{r}
high.tide <- temp.clean %>%
  filter(Tide == 'High' & !Tank_ID %in% c("TNK_SMP", "TNK_AIR"))

#to find the temeprature every 20 minutes 
#temp_20min <- high.tide %>%
  #group_by(Tank_ID, Temp_Treatment) %>%
  #filter(minute(Date) %% 20 == 0)

ggplot(high.tide, aes(y = Temp, x = Date)) +
  geom_point(aes(color = pH_Treament), na.rm = TRUE, size = 1) +
  geom_hline(aes(yintercept = Temp_Treatment), color = "black", linetype = "dashed") +
  facet_wrap(~ Tank_ID, nrow = 2) +
  theme_bw() +
  theme(
    text = element_text(family = "Arial", size = 10),
    plot.title = element_text(size = 14, hjust = 0.5, face = "bold"),
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 5),
    strip.text = element_text(size = 10, face = "bold"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank()
  ) +
  scale_y_continuous(
    breaks = seq(10, 36, by = 2),
    limits = c(10, 36),
    expand = expansion(mult = c(0.05, 0.05))
  ) +
  scale_color_manual(values = c("cyan3", "orange"), labels = c("8.0", "7.7")) +
  labs(
    title = "Mesocosm Temperature Range",
    x = "Date",
    y = expression("Temperature (°C)"),
    color = "pH Treatment"
  )



```



#HERBIVORY SCRIPT


#Linear Regression 

```{r Linear Regression for Kelp Experiment}
algae.drying.rates <- read_csv(here::here("Data", "Herbivory_Data", "Algae_Drying_Weights.csv"))
#algae.drying.rates %>% view()

algae.rates <- algae.drying.rates %>% 
  pivot_longer("0:00":"3:00", names_to="Time", values_to="Algae_Weight") 

drying.rates <- algae.rates %>% 
  mutate(Algae_Weight_Change=Initial_Algae_Weight-Algae_Weight,
         Percent_change = Algae_Weight_Change/Initial_Algae_Weight*100,
         Time=as.numeric(hm(Time))/60,
         Weight_Change_Rate=Algae_Weight_Change/Time,
         Size=case_when(Initial_Algae_Weight >= 1.2 ~ "large", #mean weight = 1.2
                        Initial_Algae_Weight <= 1.2 ~ "small")) %>% 
  dplyr::select(Time, Treatment, Initial_Algae_Weight,Percent_change, Algae_Weight, Algae_ID, Size) %>% 
  mutate_all(~replace(., is.nan(.), 0))

### Linear regression model (Y = Algae_Weight, X = Time)
model_1 <- lm(Percent_change ~ Time*Treatment, data = drying.rates)

### non-linear regression model (Y = Algae_Weight, X = Time)
model_2 <- lm(Percent_change ~ poly(Time, 2), data = drying.rates) #non-linear

#checking the models
summary(model_1)
summary(model_2)
AIC(model_1)
AIC(model_2)

#selecting the model 
model=model_2 

# Plot the four diagnostic plots
check_model(model, panel = TRUE)
#model$coefficients[1]

#Only using size categories for linear regression since there is not a difference between blotted and nonblotted rates of weight loss
small_model <- lm(Percent_change ~ poly(Time, 2), data = drying.rates %>% filter(Size=="small"))
large_model <- lm(Percent_change ~ poly(Time, 2), data = drying.rates %>% filter(Size=="large"))

#plotting regressions 
ggplot(drying.rates, aes(Time, Percent_change, color = Size)) +
  geom_point(aes(color = Size))+
  geom_smooth(method = "lm", formula = "y~ poly(x, 2)", se = TRUE)+
  stat_cor(label.y = 50)+
  facet_wrap(~Size) + theme_minimal()  +
  theme(legend.position = "top")


```


```{r Loading in Herbivory Data, message=FALSE}

##### HERBIVORY DATA ######
#reading in data 
herbivory.data <- read_csv(here::here("Data", "Herbivory_Data", "Algae_Spreadsheet.csv"))
#algae.data %>% view()

#Joining datasets
herbivory.treatment <- left_join(herbivory.data, snail.treatment)

#Cleaning data 
herbivory.treatment <- herbivory.treatment %>% 
  mutate(Size=case_when(Algae_Weight_Before >= 1.2 ~ "large",
                        Algae_Weight_Before < 1.2 ~ "small")) %>% 
  mutate(Trial_Duration = as.numeric(mdy_hm(Collection_Time_After)-mdy_hm(Placement_Time_Before))*24) %>% 
  dplyr::select(Temp_Treatment, pH_Treatment, Algae_ID, Final_Blotted_Wet_Mass_g, 
         Drying_Duration_Before, Algae_Weight_Before, Drying_Duration_After, Algae_Weight_After,
         Time_Point, Trial_Duration, Identity, Size)

#Normalizingdata from polynomial regression if data is either small or large for experimental algal weights
normalized.data <- herbivory.treatment %>% 
  mutate(percent_change_before = if_else(Size == "small",
         predict(small_model, terms = "Time",newdata = data.frame(Time = Drying_Duration_Before)), 
         predict(large_model, terms = "Time",newdata = data.frame(Time = Drying_Duration_Before))),
         percent_change_after = if_else(Size == "small",
         predict(small_model, terms = "Time",newdata = data.frame(Time = Drying_Duration_After)), 
         predict(large_model, terms = "Time",newdata = data.frame(Time = Drying_Duration_After))))

#Calculating percent change of algae 
herbivory.data <- normalized.data %>% 
  mutate(weight_change_before=(percent_change_before*0.01)*Algae_Weight_Before,
         weight_change_after=(percent_change_after*0.01)*Algae_Weight_After) %>% 
  mutate(normalized_algae_weight_before=Algae_Weight_Before + weight_change_before,
         normalized_algae_weight_after=Algae_Weight_After + weight_change_after) %>% 
  #mutate(algae_weight_change=Algae_Weight_Before-Algae_Weight_After) %>% 
  mutate(normalized_algae_weight_change=normalized_algae_weight_before-normalized_algae_weight_after,
         algae_weight_change=Algae_Weight_Before-Algae_Weight_After) 


treatment.data<- herbivory.data %>% filter(Identity=='Treatment') 

autogenic.control.data<- herbivory.data %>% filter(Identity=='Control')  %>% 
  group_by(Temp_Treatment, pH_Treatment, Time_Point) %>% 
  mutate(control_weight_change=algae_weight_change,
         control_normalized_weight_change=normalized_algae_weight_change) %>% 
  dplyr::select(Temp_Treatment, pH_Treatment, Time_Point, control_weight_change,
                control_normalized_weight_change)

controlled.data <- left_join(treatment.data, autogenic.control.data)
controlled.data <- left_join(controlled.data, snail.treatment)

#average rate of algae consumption per hour per gram of snail (controlled)
herbivory.data.final <- controlled.data %>% 
  mutate(normalized_algae_weight_change_per_snail_hr=(normalized_algae_weight_change+
         control_normalized_weight_change)/Initial_Blotted_Wet_Mass_g/Trial_Duration,
         algae_weight_change_per_snail_hr=(algae_weight_change+
         control_weight_change)/Initial_Blotted_Wet_Mass_g/Trial_Duration) %>% 
  group_by(Temp_Treatment, pH_Treatment, Algae_ID) %>% 
  summarise(normalized_algae_weight_change_per_snail_hr= mean(normalized_algae_weight_change_per_snail_hr),
            algae_weight_change_per_snail_hr = mean(algae_weight_change_per_snail_hr)) 

# Collect, check, and present data in long format. 
as_tibble(herbivory.data.final)

#Plotting the data using ggplot 
ggplot(herbivory.data.final, aes(Temp_Treatment, normalized_algae_weight_change_per_snail_hr, color=pH_Treatment)) +
  geom_point() +
  theme_bw(base_size = 12) +
  labs(x = 'Temperature (ºC)',
       y = 'Consumption Rate of Algae (g/g/hr)',
       title = 'Normalized Consumption Rate Across Temperatures')

#Plotting the data using ggplot 
ggplot(herbivory.data.final, aes(Temp_Treatment, algae_weight_change_per_snail_hr, color=pH_Treatment)) +
  geom_point() +
  theme_bw(base_size = 12) +
  labs(x = 'Temperature (ºC)',
       y = 'Consumption Rate of Algae (g/g/hr)',
       title = 'Consumption Rate Across Temperatures')


time.point.data <- controlled.data %>% 
    mutate(normalized_algae_weight_change_per_snail_hr=(normalized_algae_weight_change+
         control_normalized_weight_change)/Initial_Blotted_Wet_Mass_g/Trial_Duration,
         algae_weight_change_per_snail_hr=(algae_weight_change+
         control_weight_change)/Initial_Blotted_Wet_Mass_g/Trial_Duration) %>% 
  select(Time_Point, Temp_Treatment, pH_Treatment, normalized_algae_weight_change_per_snail_hr, algae_weight_change_per_snail_hr)

ggplot(time.point.data, aes(Temp_Treatment, algae_weight_change_per_snail_hr, color=pH_Treatment)) +
  geom_point() +
  theme_bw(base_size = 12) +
  labs(x = 'Temperature (ºC)',
       y = 'Consumption Rate of Algae (g/g/hr)',
       title = 'Consumption Rate Across Temperatures by Time Point') +
  facet_wrap(~Time_Point)

ggplot(time.point.data, aes(Temp_Treatment, normalized_algae_weight_change_per_snail_hr, color=pH_Treatment)) +
  geom_point() +
  theme_bw(base_size = 12) +
  labs(x = 'Temperature (ºC)',
       y = 'Consumption Rate of Algae (g/g/hr)',
       title = 'Normalized Consumption Rate Across Temperatures by Time Point') +
  facet_wrap(~Time_Point)

#look at each indiviudal day using facet wrap wiht normalized and non-normalized data
```

#RESPIROMETRY SCRIPT 

#Respiration Script 

```{r Loading in Respiration Script, message=FALSE}

#Set the path to the location of the raw oxygen data files
path.p<-here::here("Data","Respirometry_Data")

# importing all individual CSV files
file.names<-basename(list.files(path = path.p, pattern = "csv$", recursive = TRUE))

#renaming the file names as file.names.full
file.names.full<-list.files(path = path.p, pattern = "csv$", recursive = TRUE) 

#creating a dataframe to extract Snail_ID/Treatment from file names
str <- strsplit(file.names, "[_]")
ID_filename <- as.data.frame(matrix(unlist(str), ncol=7, byrow=TRUE))
colnames(ID_filename) <- c("Name","Temp_Treatment", "pH", "pH_Treatment", "Channel", "Cage_ID", "O2") 
ID_filename <- ID_filename %>% dplyr::select(Temp_Treatment, pH_Treatment, Channel, Cage_ID, O2)

#merging file names and separated strings
ID_filename <- ID_filename %>% 
  mutate(File_ID=file.names, pH_Treatment=as.numeric(pH_Treatment),
        Temp_Treatment = as.numeric(str_extract_all(Temp_Treatment, "[1-2][0-9]")))

#reading treatment metadata
treatment.metadata <- read_csv(here::here("Data", "Snail_Metadata","Treatment_Organism_ID_Information.csv"))

#reading respo metadata
respo.metadata <- read_csv(here::here("Data", "Snail_Metadata", "Respirometry_Metadata.csv")) 

#joining treatment, file ID, and respo metadata
treatment.metadata <-left_join(treatment.metadata, respo.metadata)
treatment.ID.metadata <- left_join(treatment.metadata, ID_filename)

#reading ash free dry weight data
afdw.data <- read_csv(here::here("Data", "Snail_Metadata","Organism_AFDW.csv"))
afdw.data <- afdw.data %>% 
  dplyr::select(Snail_ID, Ash_Free_Dry_Weight)

#reading in snail data 
snail.data <- read_csv(here::here("Data", "Snail_Metadata","Snail_Morphometric_Data.csv"))
snail.data <- snail.data %>% mutate(Snail_ID=as.character(Snail_ID))

#joining ash weight and wet weight data (selecting necessary columns)
snail.data <- left_join(snail.data, afdw.data)
snail.data <- snail.data %>%
  dplyr::select(Snail_ID, Final_Blotted_Wet_Mass_g,
         Ash_Free_Dry_Weight, Organism_Volume_mL) 

#joining treatment and snail data 
treatment.data <- left_join(treatment.ID.metadata, snail.data)

#filtering out irresponsible snails & snails not run in respirometry
treatment.data <- treatment.data %>% 
  filter(Snail_ID != 36,
         Snail_ID != 43,
         Snail_ID != 72,
         Snail_ID != 61,
         Snail_ID != 67,
         Snail_ID != 52
         ) #snail 36 mortality (not responsive to forceps)

#Cleaning treatment meta data and snail morphometric information 
treatment.data <- na_replace(treatment.data, 0) #replace NA with 0 (imputeTS package)

treatment.data.cleaned <- treatment.data %>% 
  mutate(Date=mdy(Date)) %>% 
  unite(Date, Start_Time, col="Start_Time", remove=F, sep=" ") %>% #uniting start date and time
  unite(Date, Stop_Time, col="Stop_Time", remove=F, sep=" ") %>%  #uniting stop date and time
  mutate(Start_Time = ymd_hms(Start_Time), #mutating to date format 
         Stop_Time = ymd_hms(Stop_Time)) %>% 
    dplyr::select(Snail_ID, Temp_Treatment, pH_Treatment, Ash_Free_Dry_Weight, Final_Blotted_Wet_Mass_g,
                  Organism_Volume_mL, Start_Time, Stop_Time, Channel, File_ID)
  
as_tibble(treatment.data.cleaned)

organism.weights <- treatment.data.cleaned %>% 
  select(Snail_ID, Final_Blotted_Wet_Mass_g) %>% 
  arrange(Final_Blotted_Wet_Mass_g) 

as_tibble(organism.weights)
```

# Forlooping in Respirometry Data 

## Original script created by Dr. Nyssa Silbiger modified by Robert Dellinger

```{r Foorloop Code for Respirometry Script, eval = FALSE}
#saving file names
filenames_final <- treatment.data.cleaned$File_ID

#creating data frame to import respiration data into 
RespoR <- data.frame(matrix(NA, nrow=length(filenames_final), ncol=4)) 
colnames(RespoR) <- c("File_ID","Intercept", "umol.L.sec","Temp.C") #setting column names

for(i in 1:length(filenames_final)) {
  
  #reading in each file of raw data 
  Respo.Data <- read_csv(file.path(path.p, paste0(filenames_final[i])), skip = 1) %>%
    mutate(File_ID=file.path(path.p, filenames_final[i])) %>% #adding file names
    dplyr::select(File_ID, Date, Time, Value, Temp) %>% #selecting for variables
    unite(Date, Time, col="Time", remove=T, sep = " ") %>% #creating datetime
    mutate(Time = mdy_hms(Time)) %>% # covert time
    drop_na() #omiting NAs
  
    #subsetting file names  
  subset.filenames<- sub(".*/", "", treatment.data.cleaned$File_ID[i])
  Respo.Data$File_ID <- subset.filenames  

  # Getting the file name without the .csv
  rename<- sub(".csv","", filenames_final[i])
  
  # matching file row to file name 
  Frow<-which(subset.filenames == treatment.data.cleaned$File_ID) 
  
  #start and stop time for each file name
  start<- ymd_hms(treatment.data.cleaned$Start_Time[Frow])
  stop <-ymd_hms(treatment.data.cleaned$Stop_Time[Frow])
  
  #trimming time from data 
  Respo.Data <-  Respo.Data %>%
    filter(Time >= start & Time <= stop) %>% # filter to start and stop time
    slice(500:n()) %>% # drop first 120 secs
    mutate(sec = 1:n())  # create a new column for every second for the regression
    
  Respo.Data.orig<-Respo.Data # saving original data prior to thinning
  
  #Creating a new table prior to prepare to thin data
  Respirometry.Tibble<-tibble(Time=as.numeric(), Value=as.numeric(),
                              Temp=as.numeric(), sec=as.numeric())
    
#thinning data by every 20 seconds and placing into table 
for(j in 1:nrow(Respo.Data)) { # alternative thinning strategy
    if(j%%20==0){
      Respirometry.Tibble<-rbind(Respirometry.Tibble, Respo.Data[j,])
    }
}

# plotting full data     
full.plot<- ggplot(Respo.Data.orig, aes(x = sec, y = Value)) +
    geom_point(color = "cyan3") +
    labs(x = 'Time (seconds)', y = expression(paste(' O'[2],' (',mu,'mol/L)')),
      title = "original")
  
# plotting thinned data 
thinned.plot <- ggplot(Respirometry.Tibble, aes(x = sec, y = Value))+
    geom_point(color = "cyan3")+
    labs(x = 'Time (seconds)', y = expression(paste(' O'[2],' (',mu,'mol/L)')),
      title = "thinned")
 
#bootstrapping technique (Olito et al. 2017)
Regs <- rankLocReg(xall=Respirometry.Tibble$sec, yall=Respirometry.Tibble$Value, alpha=0.5, method="pc", verbose=TRUE)  

#creates pdf of each individual respiration plot and statistics for each plot
pdf(paste0(here("Output","Respo_Output","Thinning_Plots"),"/", rename,"thinning.pdf"))
  
plot(Regs) # plot the results of the regs bootstrapping technique
plot(full.plot+thinned.plot) # use patchwork to bring the raw and thinned data together
dev.off()
  
# fill in all the O2 consumption and rate data
RespoR[i,2:3] <- Regs$allRegs[1,c(4,5)] #inserts slope and intercept in the dataframe
RespoR[i,1] <- paste0(rename,".csv") #stores the file name
RespoR[i,4] <- mean(Respirometry.Tibble$Temp, na.rm=T) #stores mean temperature organisms experienced
  
}

#writing out data as a CSV
write_csv(RespoR, here("Data", "Thinned_Respirometry_Data", "Respirometry.Data.csv")) #saves to location


```

```{r Reading Respirometry Data and Wrangling Data}

######## Reading and Merging Data #######
respirometry.data.summarized <- read_csv(here("Data", "Thinned_Respirometry_Data", "Respirometry.Data.csv")) 

#Empty chamber volume (650 mL)
Chamber_Volume <- 650

#Joining respiration data with the metadata 
joined.respo.dataset <- left_join(treatment.data.cleaned, respirometry.data.summarized)

#caclucating chamber volumes
joined.respo.dataset <- joined.respo.dataset %>%  #joining data              
mutate(Volume_mL=Chamber_Volume-Organism_Volume_mL, #calculating chamber water volume by subtracting organism volume
       umol.sec = (umol.L.sec/1000)*Volume_mL, #converting from L to mL and standardizing to water volume
       Type = as.factor(case_when(Volume_mL == 650 ~ "Blank", #Setting Control and Blank factor
                        Volume_mL < 650 ~ "Organism")))  #Full volume(650mL) = Blank
  
# Calculating control respiration rates
respo.control.data <- joined.respo.dataset %>%
  group_by(Temp_Treatment, pH_Treatment, Type) %>% #grouping by treatments
  summarise(umol.sec = mean(umol.sec, na.rm=TRUE)) %>% #means for blanks and organisms 
  filter(Type=="Blank") %>% #filtering for blanks
  dplyr::select(blank.rate = umol.sec) #selecting for only blank rates

#joining summarized control respiration data to full respiration dataset 
respo.dataset <- left_join(joined.respo.dataset, respo.control.data)

# converting from umol/sec to umol/hour and normalizing to ash free dry weight (grams)
respo.dataset <- respo.dataset %>% 
  mutate(umol.sec.uncorrected = umol.sec,
         umol.sec.corrected = umol.sec - blank.rate, # subtract the blank rates from the raw rates
         umol.gram.hr.uncorrected = umol.sec.uncorrected*3600/Ash_Free_Dry_Weight,
         umol.gram.hr.corrected = umol.sec.corrected*3600/Ash_Free_Dry_Weight) %>% 
  ungroup() %>% 
  filter(Type=="Organism") %>% 
  dplyr::select(Snail_ID, Temp_Treatment, pH_Treatment, umol.gram.hr.corrected, umol.gram.hr.uncorrected,
         Channel, Temp.C, Volume_mL)

#correcting for negative respiration rates and for values that fall below 0
respo.rates.dataset <- respo.dataset %>% 
    mutate(umol.gram.hr.corrected = -(umol.gram.hr.corrected), 
         umol.gram.hr.uncorrected = -(umol.gram.hr.uncorrected)) %>%
    mutate(umol.gram.hr.corrected = ifelse(umol.gram.hr.corrected < 0, 0, umol.gram.hr.corrected), 
         umol.gram.hr.uncorrected = ifelse(umol.gram.hr.uncorrected < 0, 0, umol.gram.hr.uncorrected))

as_tibble(respo.rates.dataset)
 
write_csv(respo.rates.dataset, here("Data", "Thinned_Respirometry_Data", "Respiration.Rates.Dataset.csv")) 

```
# Respiration Summary Statistics 

```{r Respiration Summary Statistics}
respo.rates <- read_csv(here("Data", "Thinned_Respirometry_Data", "Respiration.Rates.Dataset.csv"))

#creating a function for standard error 
se <- function(x) (sd(x) / sqrt(length(x)))

respo.rates.stats <- respo.rates %>% 
  dplyr::select(Snail_ID, Temp_Treatment, pH_Treatment, 
         umol.gram.hr.corrected, umol.gram.hr.uncorrected, Temp.C) %>%
  mutate(pH_Treatment = as.factor(pH_Treatment)) %>% 
  group_by(Temp_Treatment, pH_Treatment) %>% 
  summarize(mean.umol.gram.hr.corrected =mean(umol.gram.hr.corrected),
            var.umol.gram.hr.corrected = var(umol.gram.hr.corrected),
            sd.umol.gram.hr.corrected = sd(umol.gram.hr.corrected),
            se.umol.gram.hr.corrected =se(umol.gram.hr.corrected),
            mean.umol.gram.hr.uncorrected = mean(umol.gram.hr.uncorrected),
            var.umol.gram.hr.uncorrected = var(umol.gram.hr.uncorrected),
            sd.umol.gram.hr.uncorrected = sd(umol.gram.hr.uncorrected),
            se.umol.gram.hr.uncorrected =se(umol.gram.hr.uncorrected),
            mean.Temp.C = mean(Temp.C),
            var.Temp.C = var(Temp.C),
            sd.Temp.C = sd(Temp.C),
            se.Temp.C = se(Temp.C))

as_tibble(respo.rates.stats)
```

#Cleaning and Visualzing Data for Thermal Performance Curve Model Selection

```{r Cleaning and Visualizing Respo Data for rTPC Model Selection}


#load in the data set and select for temperature, rate, and pH treatment
respo.rates.tpc <- respo.rates %>% 
  mutate(rate=umol.gram.hr.corrected, temp=Temp.C) %>%
  dplyr::select(pH_Treatment, temp, rate)

# load in data and filter to keep just a single curve (low pH)
low.pH <- filter(respo.rates.tpc, pH_Treatment == '7.7') 

# load in data and filter to keep just a single curve (high pH)
high.pH <- filter(respo.rates.tpc, pH_Treatment == '8') 

#loading tegula icon in
image=here::here("Images", "Tegula_funebralis_icon.png")

# show the data
low.pH.points <- ggplot(low.pH, aes(temp, rate)) +
  geom_image(aes(image=image), size=.075) +
  theme_bw(base_size = 12) +
  labs(x = 'Temperature (ºC)',
       y = 'Metabolic Rate',
       title = 'Respiration Across Temperatures 
                      (low pH)')

# show the data
high.pH.points <- ggplot(high.pH, aes(temp, rate)) +
  geom_image(aes(image=image), size=.075) +
  theme_bw(base_size = 12) +
  labs(x = 'Temperature (ºC)',
       y = 'Metabolic Rate',
       title = 'Respiration Across Temperatures
                      (high pH)')

#Printing Both Plots
grid.arrange(low.pH.points , high.pH.points, ncol=2)

```

# Thermal Performance Curve Model Selection 

```{r Thermal Performance Model Selection, message= FALSE}

# fit selected model formulations in rTPC (low pH)
low_pH_model_fits <- nest(low.pH, data = c(temp, rate)) %>%
  mutate(gaussian = map(data, ~nls_multstart(rate~gaussian_1987(temp=temp, rmax, topt, a),
                        data = .x,
                        iter = c(4,4,4),
                        start_lower = get_start_vals(.x$temp, .x$rate, model_name = 'gaussian_1987') - 10,
                        start_upper = get_start_vals(.x$temp, .x$rate, model_name = 'gaussian_1987') + 10,
                        lower = get_lower_lims(.x$temp, .x$rate, model_name = 'gaussian_1987'),
                        upper = get_upper_lims(.x$temp, .x$rate, model_name = 'gaussian_1987'),
                        supp_errors = 'Y',
                        convergence_count = FALSE)),
         modifiedgaussian = map(data, ~nls_multstart(rate~modifiedgaussian_2006(temp=temp, rmax, topt, a, b),
                        data = .x,
                        iter = c(4,4,4,4),
                        start_lower = get_start_vals(.x$temp, .x$rate, model_name = 'modifiedgaussian_2006') - 10,
                        start_upper = get_start_vals(.x$temp, .x$rate, model_name = 'modifiedgaussian_2006') + 10,
                        lower = get_lower_lims(.x$temp, .x$rate, model_name = 'modifiedgaussian_2006'),
                        upper = get_upper_lims(.x$temp, .x$rate, model_name = 'modifiedgaussian_2006'),
                        supp_errors = 'Y',
                        convergence_count = FALSE)),
         sharpeschoolfull = map(data, ~nls_multstart(rate~sharpeschoolfull_1981(temp = temp, r_tref,e,el,tl,eh,th, tref = 15),
                        data = .x,
                        iter = c(4,4,4,4,4,4),
                        start_lower = get_start_vals(.x$temp, .x$rate, model_name = 'sharpeschoolfull_1981') - 10,
                        start_upper = get_start_vals(.x$temp, .x$rate, model_name = 'sharpeschoolfull_1981') + 10,
                        lower = get_lower_lims(.x$temp, .x$rate, model_name = 'sharpeschoolfull_1981'),
                        upper = get_upper_lims(.x$temp, .x$rate, model_name = 'sharpeschoolfull_1981'),
                        supp_errors = 'Y',
                        convergence_count = FALSE)),
         sharpeschoolhigh = map(data, ~nls_multstart(rate~sharpeschoolhigh_1981(temp = temp, r_tref,e,eh,th, tref = 15),
                        data = .x,
                        iter = c(4,4,4,4),
                        start_lower = get_start_vals(.x$temp, .x$rate, model_name = 'sharpeschoolhigh_1981') - 10,
                        start_upper = get_start_vals(.x$temp, .x$rate, model_name = 'sharpeschoolhigh_1981') + 10,
                        lower = get_lower_lims(.x$temp, .x$rate, model_name = 'sharpeschoolhigh_1981'),
                        upper = get_upper_lims(.x$temp, .x$rate, model_name = 'sharpeschoolhigh_1981'),
                        supp_errors = 'Y',
                        convergence_count = FALSE)),
         sharpeschoollow = map(data, ~nls_multstart(rate~sharpeschoollow_1981(temp = temp, r_tref,e,el,tl, tref = 15),
                        data = .x,
                        iter = c(4,4,4,4),
                        start_lower = get_start_vals(.x$temp, .x$rate, model_name = 'sharpeschoollow_1981') - 10,
                        start_upper = get_start_vals(.x$temp, .x$rate, model_name = 'sharpeschoollow_1981') + 10,
                        lower = get_lower_lims(.x$temp, .x$rate, model_name = 'sharpeschoollow_1981'),
                        upper = get_upper_lims(.x$temp, .x$rate, model_name = 'sharpeschoollow_1981'),
                        supp_errors = 'Y',
                        convergence_count = FALSE)),
         weibull = map(data, ~nls_multstart(rate~weibull_1995(temp = temp, a,topt,b,c),
                        data = .x,
                        iter = c(4,4,4,4),
                        start_lower = get_start_vals(.x$temp, .x$rate, model_name = 'weibull_1995') - 10,
                        start_upper = get_start_vals(.x$temp, .x$rate, model_name = 'weibull_1995') + 10,
                        lower = get_lower_lims(.x$temp, .x$rate, model_name = 'weibull_1995'),
                        upper = get_upper_lims(.x$temp, .x$rate, model_name = 'weibull_1995'),
                        supp_errors = 'Y',
                        convergence_count = FALSE)))

# fit selected model formulations in rTPC (high pH)
high_pH_model_fits <- nest(high.pH, data = c(temp, rate)) %>%
  mutate(gaussian = map(data, ~nls_multstart(rate~gaussian_1987(temp=temp, rmax, topt, a),
                        data = .x,
                        iter = c(4,4,4),
                        start_lower = get_start_vals(.x$temp, .x$rate, model_name = 'gaussian_1987') - 10,
                        start_upper = get_start_vals(.x$temp, .x$rate, model_name = 'gaussian_1987') + 10,
                        lower = get_lower_lims(.x$temp, .x$rate, model_name = 'gaussian_1987'),
                        upper = get_upper_lims(.x$temp, .x$rate, model_name = 'gaussian_1987'),
                        supp_errors = 'Y',
                        convergence_count = FALSE)),
         modifiedgaussian = map(data, ~nls_multstart(rate~modifiedgaussian_2006(temp=temp, rmax, topt, a, b),
                        data = .x,
                        iter = c(4,4,4,4),
                        start_lower = get_start_vals(.x$temp, .x$rate, model_name = 'modifiedgaussian_2006') - 10,
                        start_upper = get_start_vals(.x$temp, .x$rate, model_name = 'modifiedgaussian_2006') + 10,
                        lower = get_lower_lims(.x$temp, .x$rate, model_name = 'modifiedgaussian_2006'),
                        upper = get_upper_lims(.x$temp, .x$rate, model_name = 'modifiedgaussian_2006'),
                        supp_errors = 'Y',
                        convergence_count = FALSE)),
         sharpeschoolfull = map(data, ~nls_multstart(rate~sharpeschoolfull_1981(temp = temp, r_tref,e,el,tl,eh,th, tref = 15),
                        data = .x,
                        iter = c(4,4,4,4,4,4),
                        start_lower = get_start_vals(.x$temp, .x$rate, model_name = 'sharpeschoolfull_1981') - 10,
                        start_upper = get_start_vals(.x$temp, .x$rate, model_name = 'sharpeschoolfull_1981') + 10,
                        lower = get_lower_lims(.x$temp, .x$rate, model_name = 'sharpeschoolfull_1981'),
                        upper = get_upper_lims(.x$temp, .x$rate, model_name = 'sharpeschoolfull_1981'),
                        supp_errors = 'Y',
                        convergence_count = FALSE)),
         sharpeschoolhigh = map(data, ~nls_multstart(rate~sharpeschoolhigh_1981(temp = temp, r_tref,e,eh,th, tref = 15),
                        data = .x,
                        iter = c(4,4,4,4),
                        start_lower = get_start_vals(.x$temp, .x$rate, model_name = 'sharpeschoolhigh_1981') - 10,
                        start_upper = get_start_vals(.x$temp, .x$rate, model_name = 'sharpeschoolhigh_1981') + 10,
                        lower = get_lower_lims(.x$temp, .x$rate, model_name = 'sharpeschoolhigh_1981'),
                        upper = get_upper_lims(.x$temp, .x$rate, model_name = 'sharpeschoolhigh_1981'),
                        supp_errors = 'Y',
                        convergence_count = FALSE)),
         sharpeschoollow = map(data, ~nls_multstart(rate~sharpeschoollow_1981(temp = temp, r_tref,e,el,tl, tref = 15),
                        data = .x,
                        iter = c(4,4,4,4),
                        start_lower = get_start_vals(.x$temp, .x$rate, model_name = 'sharpeschoollow_1981') - 10,
                        start_upper = get_start_vals(.x$temp, .x$rate, model_name = 'sharpeschoollow_1981') + 10,
                        lower = get_lower_lims(.x$temp, .x$rate, model_name = 'sharpeschoollow_1981'),
                        upper = get_upper_lims(.x$temp, .x$rate, model_name = 'sharpeschoollow_1981'),
                        supp_errors = 'Y',
                        convergence_count = FALSE)),
         weibull = map(data, ~nls_multstart(rate~weibull_1995(temp = temp, a,topt,b,c),
                        data = .x,
                        iter = c(4,4,4,4),
                        start_lower = get_start_vals(.x$temp, .x$rate, model_name = 'weibull_1995') - 10,
                        start_upper = get_start_vals(.x$temp, .x$rate, model_name = 'weibull_1995') + 10,
                        lower = get_lower_lims(.x$temp, .x$rate, model_name = 'weibull_1995'),
                        upper = get_upper_lims(.x$temp, .x$rate, model_name = 'weibull_1995'),
                        supp_errors = 'Y',
                        convergence_count = FALSE)))

#glimpse(low_pH_model_fits)
#glimpse(high_pH_model_fits)

# stack models for low pH 
low_pH_model_stack <- dplyr::select(low_pH_model_fits, -data) %>%
  pivot_longer(., names_to = 'model_name', values_to = 'fit', gaussian:weibull)

# stack models for high pH
high_pH_model_stack <- dplyr::select(high_pH_model_fits, -data) %>%
  pivot_longer(., names_to = 'model_name', values_to = 'fit', gaussian:weibull)

# get parameters using tidy
low_pH_model_params <- low_pH_model_stack %>%
  mutate(., est = map(fit, tidy)) %>%
  dplyr::select(-fit) %>%
  unnest(est)

# get parameters using tidy
high_pH_model_params <- high_pH_model_stack %>%
  mutate(., est = map(fit, tidy)) %>%
  dplyr::select(-fit) %>%
  unnest(est)

# get predictions using augment
low_pH_model_newdata <- tibble(temp = seq(min(low.pH$temp), max(low.pH$temp), length.out = 100))

# get predictions using augment
high_pH_model_newdata <- tibble(temp = seq(min(high.pH$temp), max(high.pH$temp), length.out = 100))

low_pH_model_preds <- low_pH_model_stack %>%
  mutate(., preds = map(fit, augment, newdata = low_pH_model_newdata)) %>%
  dplyr::select(-fit) %>%
  unnest(preds)

high_pH_model_preds <- high_pH_model_stack %>%
  mutate(., preds = map(fit, augment, newdata = high_pH_model_newdata)) %>%
  dplyr::select(-fit) %>%
  unnest(preds)

# write function to label ggplot2 panels
label_facets_num <- function(string){
  len <- length(string)
  string = paste('(', 1:len, ') ', string, sep = '')
  return(string)
}

# plot rTPC model fits using ggplot2
ggplot(low_pH_model_preds, aes(temp, rate)) +
  geom_point(aes(temp, rate), low.pH) +
  geom_line(aes(temp, .fitted, col = model_name)) +
  facet_wrap(~model_name, labeller = labeller(model_name = label_facets_num), scales = 'free', ncol = 3) +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        strip.text = element_text(hjust = 0),
        strip.background = element_blank()) +
  labs(x = 'Temperature (ºC)',
       y = 'Metabolic rate',
       title = 'rTPC Model Fits - low pH') +
  geom_hline(aes(yintercept = 0), linetype = 2)+
  scale_color_brewer(type = 'qual', palette = 2)

# plot rTPC model fits using ggplot2
ggplot(high_pH_model_preds, aes(temp, rate)) +
  geom_point(aes(temp, rate), high.pH) +
  geom_line(aes(temp, .fitted, col = model_name)) +
  facet_wrap(~model_name, labeller = labeller(model_name = label_facets_num), scales = 'free', ncol = 3) +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        strip.text = element_text(hjust = 0),
        strip.background = element_blank()) +
  labs(x = 'Temperature (ºC)',
       y = 'Metabolic rate',
       title = 'rTPC Model Fits - high pH') +
  geom_hline(aes(yintercept = 0), linetype = 2)+
  scale_color_brewer(type = 'qual', palette = 2)

#selecting a random point from each model for labeling
high_pH_model_labs <- filter(high_pH_model_preds, temp < 26) %>%
  group_by(., model_name) %>%
  sample_n(., 1) %>%
  ungroup()

low_pH_model_labs <- filter(low_pH_model_preds, temp < 26) %>%
  group_by(., model_name) %>%
  sample_n(., 1) %>%
  ungroup()

# multiple models low pH plot
low.pH.model.plot <- ggplot(low_pH_model_preds, aes(temp, .fitted)) +
  geom_line(aes(col = model_name)) +
  geom_label_repel(aes(temp, .fitted, label = model_name, col = model_name), fill = 'white', nudge_y = 2, segment.size = 0.5, segment.colour = 'grey50', low_pH_model_labs) +
  geom_point(aes(temp, rate), low.pH) +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none') +
  labs(x = 'Temperature (ºC)',
       y = 'Metabolic rate',
       title = 'rTPC Model Fits - low pH') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2)

# multiple models high pH plot
high.pH.model.plot<- ggplot(high_pH_model_preds, aes(temp, .fitted)) +
  geom_line(aes(col = model_name)) +
  geom_label_repel(aes(temp, .fitted, label = model_name, col = model_name), fill = 'white', nudge_y = 2, segment.size = 0.5, segment.colour = 'grey50', high_pH_model_labs) +
  geom_point(aes(temp, rate), high.pH) +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none') +
  labs(x = 'Temperature (ºC)',
       y = 'Metabolic rate',
       title = 'rTPC Model Fits - high pH') +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  scale_color_brewer(type = 'qual', palette = 2)

#Printing Both Plots
grid.arrange(high.pH.model.plot, low.pH.model.plot, ncol=2)

#extracting model fit information from the model output - high pH
high_pH_model_ic <- high_pH_model_stack %>%
  mutate(., info = map(fit, glance),
         AICc =  map_dbl(fit, MuMIn::AICc),
         pH_Treatment="8.0") %>%
  dplyr::select(-fit) %>%
  unnest(info) %>%
  dplyr::select(model_name, pH_Treatment, sigma, AIC, AICc, BIC)

#extracting model fit information from the model output - low pH
low_pH_model_ic <- low_pH_model_stack %>%
  mutate(., info = map(fit, glance),
         AICc =  map_dbl(fit, MuMIn::AICc),
         pH_Treatment="7.7") %>%
  dplyr::select(-fit) %>%
  unnest(info) %>%
  dplyr::select(model_name, pH_Treatment, sigma, AIC, AICc, BIC)

models_AIC <- full_join(low_pH_model_ic, high_pH_model_ic) %>% arrange(model_name)

models_AIC %>% 
  group_by(model_name) %>% 
  gt(rowname_col = "pH_Treatment") %>%
  tab_header(title = md("**Thermal Performance Models Statistical Summaries**")) %>% 
  gt_highlight_rows(rows = 7:8, font_weight = "normal") 

# getting information on measures of relative model fit 
#AIC, BIC, and AICc (AIC correcting for small sample size)
```

#AIC model difference of 2-4 (look at model selectin and AIC values) 
Choose the Sharpe Schoolfield model(high) because it had the lowest AIC values for 7.7 and 8.0 pH, collectively and was a biological model used for ectotherms that fit the curve correctly. 


#Respiration Thermal Performance Curve

```{r}

########### Low pH Sharpe-Schoolfield Model ################
# fit Sharpe-Schoolfield model
low_pH_fit <- nest(low.pH, data = c(temp, rate)) %>%
  mutate(sharpeschoolhigh = map(data, ~nls_multstart(rate~sharpeschoolhigh_1981(temp = temp, r_tref,e,eh,th, tref = 15),
                        data = .x,
                        iter = c(3,3,3,3),
                        start_lower = get_start_vals(.x$temp, .x$rate, model_name = 'sharpeschoolhigh_1981') - 10,
                        start_upper = get_start_vals(.x$temp, .x$rate, model_name = 'sharpeschoolhigh_1981') + 10,
                        lower = get_lower_lims(.x$temp, .x$rate, model_name = 'sharpeschoolhigh_1981'),
                        upper = get_upper_lims(.x$temp, .x$rate, model_name = 'sharpeschoolhigh_1981'),
                        supp_errors = 'Y',
                        convergence_count = FALSE)),
         # create new temperature data
         low_pH_new_data = map(data, ~tibble(temp = seq(min(.x$temp), max(.x$temp), length.out = 100))),
         # predict over that data,
         low_pH_preds =  map2(sharpeschoolhigh, low_pH_new_data, ~augment(.x, newdata = .y)))

# unnest predictions
low_pH_preds <- dplyr::select(low_pH_fit, low_pH_preds) %>%
  unnest(low_pH_preds)

########### High pH Sharpe-Schoolfield Model ################

# load in data and filter to keep just a single curve (lowpH)
high.pH <- filter(respo.rates.tpc, pH_Treatment == '8') 

# fit Sharpe-Schoolfield model
high_pH_fit <- nest(high.pH, data = c(temp, rate)) %>%
  mutate(sharpeschoolhigh = map(data, ~nls_multstart(rate~sharpeschoolhigh_1981(temp = temp, r_tref,e,eh,th, tref = 15),
                        data = .x,
                        iter = c(3,3,3,3),
                        start_lower = get_start_vals(.x$temp, .x$rate, model_name = 'sharpeschoolhigh_1981') - 10,
                        start_upper = get_start_vals(.x$temp, .x$rate, model_name = 'sharpeschoolhigh_1981') + 10,
                        lower = get_lower_lims(.x$temp, .x$rate, model_name = 'sharpeschoolhigh_1981'),
                        upper = get_upper_lims(.x$temp, .x$rate, model_name = 'sharpeschoolhigh_1981'),
                        supp_errors = 'Y',
                        convergence_count = FALSE)),
         # create new temperature data
         high_pH_new_data = map(data, ~tibble(temp = seq(min(.x$temp), max(.x$temp), length.out = 100))),
         # predict over that data,
         high_pH_preds =  map2(sharpeschoolhigh, high_pH_new_data, ~augment(.x, newdata = .y)))

# unnest predictions
high_pH_preds <- dplyr::select(high_pH_fit, high_pH_preds) %>%
  unnest(high_pH_preds)

# plot data and predictions
low.pH.plot <- ggplot() +
  geom_line(aes(temp, .fitted), low_pH_preds, col = 'orange') +
  geom_image(aes(temp, rate, image=image), low.pH, size = 0.075, alpha = 0.5) +
  theme_bw(base_size = 9) +
  labs(x = 'Temperature (ºC)',
       y = 'Respiration Rate',
       title = 'Respiration Rate of Tegula Across\nA Range of Temperatures at Low pH')

# plot data and predictions
high.pH.plot <- ggplot() +
  geom_line(aes(temp, .fitted), high_pH_preds, col = 'cyan3') +
  geom_image(aes(temp, rate, image=image), high.pH, size = 0.075, alpha = 0.5) +
  theme_bw(base_size = 9) +
  labs(x = 'Temperature (ºC)',
       y = 'Respiration Rate',
       title = 'Respiration Rate of Tegula Across\nA Range of Temperatures at High pH')

#Printing Both Plots
grid.arrange(low.pH.plot, high.pH.plot, ncol=2)

```
# Bootstrap models 
```{r}

### Low pH portion ###
# Refit model using nlsLM
low_fit_nlsLM <- minpack.lm::nlsLM(rate ~ sharpeschoolhigh_1981(temp = temp, r_tref, e, eh, th, tref = 15),
                                   data = low.pH,
                                   start = coef(low_pH_fit$sharpeschoolhigh[[1]]),
                                   lower = get_lower_lims(low.pH$temp, low.pH$rate, model_name = 'sharpeschoolhigh_1981'),
                                   upper = get_upper_lims(low.pH$temp, low.pH$rate, model_name = 'sharpeschoolhigh_1981'),
                                   weights = rep(1, nrow(low.pH)))

# Bootstrap using case resampling
boot.low.pH <- Boot(low_fit_nlsLM, method = 'case')

# Create predictions of each bootstrapped model
boot_low_preds <- boot.low.pH$t %>%
  as.data.frame() %>%
  drop_na() %>%
  mutate(iter = row_number()) %>%
  group_by_all() %>%
  do(data.frame(temp = seq(min(low.pH$temp), max(low.pH$temp), length.out = 100))) %>%
  ungroup() %>%
  mutate(pred = sharpeschoolhigh_1981(temp, r_tref, e, eh, th, tref = 15))

# Calculate bootstrapped confidence intervals
boot_low_conf_preds <- boot_low_preds %>%
  group_by(temp) %>%
  summarise(conf_lower = quantile(pred, 0.025),
            conf_upper = quantile(pred, 0.975)) %>%
  ungroup()

# Plot bootstrapped CIs
boot.low.pH.plot <- ggplot() +
  geom_line(aes(temp, .fitted), data = low_pH_preds, col = 'orange') +
  geom_ribbon(aes(temp, ymin = conf_lower, ymax = conf_upper), data = boot_low_conf_preds, fill = 'orange', alpha = 0.3) +
  geom_image(aes(temp, rate, image = image), data = low.pH, size = 0.075, alpha = 0.5) +
  theme_bw(base_size = 12) +
  labs(x = 'Temperature (ºC)',
       y = 'Respiration Rate',
       title = 'Respiration Rate (pH ~7.7)') +
  scale_y_continuous(limits = c(0, 120), breaks = seq(0, 120, by = 20)) +
  scale_x_continuous(limits = c(12, 26), breaks = seq(12, 26, by = 2)) +
  theme(plot.title = element_text(hjust = 0.5))

# Plot bootstrapped predictions
boot.low.pH.plot.predictions <- ggplot() +
  geom_line(aes(temp, .fitted), data = low_pH_preds, col = 'orange') +
  geom_line(aes(temp, pred, group = iter), data = boot_low_preds, col = 'orange', alpha = 0.007) +
  geom_image(aes(temp, rate, image = image), data = low.pH, size = 0.075, alpha = 0.5) +
  theme_bw(base_size = 12) +
  labs(x = 'Temperature (ºC)',
       y = 'Respiration Rate',
       title = 'Respiration Rate (pH ~7.7)') +
  scale_y_continuous(limits = c(0, 120), breaks = seq(0, 120, by = 20)) +
  scale_x_continuous(limits = c(12, 26), breaks = seq(12, 26, by = 2)) +
  theme(plot.title = element_text(hjust = 0.5))


### High pH portion ###
# Refit model using nlsLM
high_fit_nlsLM <- minpack.lm::nlsLM(rate ~ sharpeschoolhigh_1981(temp = temp, r_tref, e, eh, th, tref = 15),
                                    data = high.pH,
                                    start = coef(high_pH_fit$sharpeschoolhigh[[1]]),
                                    lower = get_lower_lims(high.pH$temp, high.pH$rate, model_name = 'sharpeschoolhigh_1981'),
                                    upper = get_upper_lims(high.pH$temp, high.pH$rate, model_name = 'sharpeschoolhigh_1981'),
                                    weights = rep(1, nrow(high.pH)))

# Bootstrap using case resampling
boot.high.pH <- Boot(high_fit_nlsLM, method = 'case')

# Create predictions of each bootstrapped model
boot_high_preds <- boot.high.pH$t %>%
  as.data.frame() %>%
  drop_na() %>%
  mutate(iter = row_number()) %>%
  group_by_all() %>%
  do(data.frame(temp = seq(min(high.pH$temp), max(high.pH$temp), length.out = 100))) %>%
  ungroup() %>%
  mutate(pred = sharpeschoolhigh_1981(temp, r_tref, e, eh, th, tref = 15))

# Calculate bootstrapped confidence intervals
boot_high_conf_preds <- boot_high_preds %>%
  group_by(temp) %>%
  summarise(conf_lower = quantile(pred, 0.025),
            conf_upper = quantile(pred, 0.975)) %>%
  ungroup()

# Plot bootstrapped CIs
boot.high.pH.plot <- ggplot() +
  geom_line(aes(temp, .fitted), data = high_pH_preds, col = 'cyan3') +
  geom_ribbon(aes(temp, ymin = conf_lower, ymax = conf_upper), data = boot_high_conf_preds, fill = 'cyan3', alpha = 0.3) +
  geom_image(aes(temp, rate, image = image), data = high.pH, size = 0.075, alpha = 0.5) +
  theme_bw(base_size = 12) +
  labs(x = 'Temperature (ºC)',
       y = 'Respiration Rate',
       title = 'Respiration Rate (pH ~8.0)') +
  scale_y_continuous(limits = c(0, 120), breaks = seq(0, 120, by = 20)) +
  scale_x_continuous(limits = c(12, 26), breaks = seq(12, 26, by = 2)) +
  theme(plot.title = element_text(hjust = 0.5))

# Plot bootstrapped predictions
boot.high.pH.plot.predictions <- ggplot() +
  geom_line(aes(temp, .fitted), data = high_pH_preds, col = 'cyan3') +
  geom_line(aes(temp, pred, group = iter), data = boot_high_preds, col = 'cyan3', alpha = 0.007) +
  geom_image(aes(temp, rate, image = image), data = high.pH, size = 0.075, alpha = 0.5) +
  theme_bw(base_size = 12) +
  labs(x = 'Temperature (ºC)',
       y = 'Respiration Rate',
       title = 'Respiration Rate (pH ~8.0)') +
  scale_y_continuous(limits = c(0, 120), breaks = seq(0, 120, by = 20)) +
  scale_x_continuous(limits = c(12, 26), breaks = seq(12, 26, by = 2)) +
  theme(plot.title = element_text(hjust = 0.5))

# Combine the plots
low_combined_plot <- grid.arrange(boot.low.pH.plot, 
                              boot.low.pH.plot.predictions, 
                              nrow = 1, ncol = 2)

# Display the combined plot
print(low_combined_plot)

# Combine the plots
high_combined_plot <- grid.arrange(boot.high.pH.plot, 
                              boot.high.pH.plot.predictions, 
                              nrow = 1, ncol = 2)

# Display the combined plot
print(high_combined_plot)

```





#Extracting TPC parameters 

```{r}


high_extra_params <- calc_params(high_fit_nlsLM) %>%
  pivot_longer(everything(), names_to =  'param', values_to = 'estimate')


high_ci_extra_params <- Boot(high_fit_nlsLM, f = function(x){unlist(calc_params(x))}, labels = names(calc_params(high_fit_nlsLM)), R = 999, method = 'case') %>%
  confint(., method = 'bca') %>%
  as.data.frame() %>%
  rename(conf_lower = 1, conf_upper = 2) %>%
  rownames_to_column(., var = 'param') %>%
  mutate(method = 'case bootstrap')
  
#may need to increase max number of iterations 

high_pH_ci_extra_params <- left_join(high_ci_extra_params, high_extra_params)
high_pH_TPC_parameters <- as_tibble(high_pH_ci_extra_params)%>% 
  mutate(Treatment="8.0")

low_extra_params <- calc_params(low_fit_nlsLM) %>%
  pivot_longer(everything(), names_to =  'param', values_to = 'estimate')

low_ci_extra_params <- Boot(low_fit_nlsLM, f = function(x){unlist(calc_params(x))}, labels = names(calc_params(low_fit_nlsLM)), R = 999, method = 'case') %>%
  confint(., method = 'bca') %>%
  as.data.frame() %>%
  rename(conf_lower = 1, conf_upper = 2) %>%
  rownames_to_column(., var = 'param') %>%
  mutate(method = 'case bootstrap')
  
low_pH_ci_extra_params <- left_join(low_ci_extra_params, low_extra_params)
low_pH_TPC_parameters <- as_tibble(low_pH_ci_extra_params) %>% 
  mutate(Treatment="7.7")

#Presenting TPC parameter data as a table 
TPC_parameters <- full_join(high_pH_TPC_parameters, low_pH_TPC_parameters) 
as_tibble(TPC_parameters)
  
#selecting for parameters we want for the figures
graph_TPC_parameters <- TPC_parameters %>% 
  subset(param %in% c('ctmin', 'ctmax', 'topt', 'rmax', 'breadth', 'e', 'eh', 'q10'))

graph_TPC_parameters %>% pivot_wider(names_from=Treatment, values_from=c(conf_lower, conf_upper, estimate))
  

# TPC parameters plot
ggplot(graph_TPC_parameters, aes(forcats::fct_relevel(Treatment), estimate, color = Treatment)) +
  geom_point(size = 2) +
  geom_linerange(aes(ymin = conf_lower, ymax = conf_upper)) +
  theme_bw(base_size = 12) +
  facet_wrap(~param, scales = 'free') +
  scale_x_discrete('', labels = function(x) stringr::str_wrap(x, width = 10)) +
  labs(title = 'Calculation of Confidence Intervals Between
       Thermal Performance Parameters',
       x = 'Treatment',
       y = 'Estimate',
       color = 'Treatment') +
  scale_color_manual(values = c("orange", "cyan3")) +  # Set colors as orange and blue
  theme(plot.title = element_text(hjust = 0.5))  # Center the plot title


```

