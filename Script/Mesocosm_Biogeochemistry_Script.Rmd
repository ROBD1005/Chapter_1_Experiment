---
title: "Mesocosm Environmental Parameters"
output:
  pdf_document: default
  html_document: default
date: "2023-09-14"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(seacarb)
library(broom)
library(here)
library(lubridate)
library(ggridges)
library(dplyr)
library(ggplot2)
library(knitr)
library(ggsignif)
library(respirometry)
```

## Common theme for plotting 

```{r}
# Define a custom theme for ggplot
common_theme <- theme_minimal(base_family="serif") +
  theme(
    # Set the background to white
    plot.background = element_rect(fill = "white", colour = "white"),
    # Set font family and color for text
    text = element_text(family = "serif", color = "black"),
    # Remove legend
    legend.position = 'none',
    # Adjust strip text for facetted plots
    strip.text = element_text(hjust = 0.5, size = 9, family = "serif"), 
    strip.text.x = element_text(vjust = 0.5, size = 11, family = "serif"), 
    strip.text.y = element_text(vjust = 0.5, size = 11, family = "serif"), 
    # Adjust axis titles
    axis.title.x = element_text(margin = margin(t = 7.5), size = 11, hjust = 0.5, family = "serif"),
    axis.title.y = element_text(margin = margin(r = 7.5), size = 11, vjust = 0.5, family = "serif"),
    # Adjust axis text
    axis.text = element_text(size = 9, family = "serif"),
    # Adjust plot title
    plot.title = element_text(hjust = 0.5, size = 14, family = "serif"),
    # Adjust plot margins
    plot.margin = margin(t = 1, r = 1, b = 1, l = 1, unit = "cm"),
    # Increase line thickness
    panel.border = element_rect(color = NA, fill = NA, size = 0.5),
    # Set panel grid lines
    panel.grid.major = element_line(color = "gray75", linewidth = 0.2),
    panel.grid.minor = element_blank()
  )
```

# Mesocosm Carbonate System Calculations 

## Reading in pH calibration data and calculating pH and reading in total alkalinity data to calcualte carbinate system parameters within the mesocosm system

```{r Mesocosm pH, Total Alkalinity, and Carbonate System Calculations}

# Read in daily mesocosm data 
mesocosm_daily_data <- read_csv(here("Data", "Mesocosm_Data", "Mesocosm_Daily_Datasheet.csv"),
  show_col_types = FALSE) %>%
  mutate(Date = mdy(Date), 
         Tank_ID = as.factor(Tank_ID), 
         pH_Treatment = as.factor(pH_Treatment), 
         Temp_Treatment = as.factor(Temp_Treatment))

# Read pH calibration data
pHcalib <- read_csv(here("Data", "Mesocosm_Data", "TrispHcalibration.csv"), show_col_types = FALSE) %>%
  mutate(TrisCalDate = ymd(TrisCalDate))

# Read mesocosm daily datasheet and select relevant columns
pHData <- read_csv(here("Data", "Mesocosm_Data", "Mesocosm_Daily_Datasheet.csv"),
  show_col_types = FALSE) %>%
  mutate(TrisCalDate = ymd(TrisCalDate),
         Date = mdy(Date), 
         Temp_Treatment = as.factor(Temp_Treatment), 
         pH_Treatment = as.factor(pH_Treatment),
         Tank_ID = as.factor(Tank_ID)) %>% 
  dplyr::select(Temp_C, mV, Salinity, TrisCalDate, Date, Tank_ID, pH_Treatment, Temp_Treatment)

# Calculate pH values using calibration data
pHSlope <- pHcalib %>%
  group_by(TrisCalDate) %>%
  summarise(fitpH = list(lm(mVTris ~ TTris, data = cur_data()))) %>%
  mutate(tidy_fit = map(fitpH, broom::tidy)) %>%
  unnest(tidy_fit) %>%
  dplyr::select(TrisCalDate, term, estimate) %>%
  pivot_wider(names_from = term, values_from = estimate)

# Join pH calibration data with daily mesocosm data
pHjoined <- left_join(pHData, pHSlope, by = "TrisCalDate") %>%
  mutate(mVTris_calc = Temp_C * TTris + `(Intercept)`) %>%
  drop_na(Temp_C, mV)

# Calculate pH
pHcalc <- pHjoined %>%
  mutate(pH = seacarb::pH(Ex = mV, Etris = mVTris_calc, S = Salinity, T = Temp_C)) %>%
   dplyr::select(Date, Tank_ID, pH_Treatment, Temp_Treatment, pH)

# Read and process Total Alkalinity (TA) data
read_process_TA_data <- function(file_path, date, start_date, end_date) {
  read_csv(file_path, show_col_types = FALSE) %>% 
    mutate(Date = as.Date(date),
           Start_Date = as.Date(start_date),
           End_Date = as.Date(end_date)) %>%
    rename(Tank_ID = SampleID) %>%
    mutate(Tank_ID = gsub("-", "_", Tank_ID),
           Tank_ID = gsub("TNK_SUMP", "TNK_SMP", Tank_ID)) %>%
    group_by(Tank_ID) %>%
    do({
      df <- .
      dates <- seq(.$Start_Date, .$End_Date, by = "day")
      df[rep(seq_len(nrow(df)), each = length(dates)), ] %>%
        mutate(Date = dates)
    }) %>%
    ungroup() %>%
    dplyr::select(Date, Tank_ID, TA, TA_evap)
}

# Read and process TA data for different dates
TAdata_combined <- bind_rows(
  read_process_TA_data(here("Data", "Mesocosm_Data", "Total_Alkalinity", "TA2022-09-01.csv"), "2022-09-01", "2022-08-27", "2022-09-01"),
  read_process_TA_data(here("Data", "Mesocosm_Data", "Total_Alkalinity", "TA2022-08-22.csv"), "2022-08-22", "2022-08-22", "2022-08-26"),
  read_process_TA_data(here("Data", "Mesocosm_Data", "Total_Alkalinity", "TA2022-08-16.csv"), "2022-08-16", "2022-08-16", "2022-08-21")
) %>%
  filter(Tank_ID != "CRM",
         Tank_ID != "Junk") %>% 
   dplyr::select(Date, Tank_ID, TA) %>%
  arrange(Date, Tank_ID)

# Merge TA and pH data
completed_meso_data <- left_join(mesocosm_daily_data, pHcalc, by = c("Date", "Tank_ID", "pH_Treatment", "Temp_Treatment")) %>%
  left_join(TAdata_combined, by = c("Date", "Tank_ID"))

# Convert TA from µmol/kg to mol/kg
completed_meso_data <- completed_meso_data %>% 
  mutate(TA = TA * 1e-6) 

# Initialize columns for carbonate system parameters
completed_meso_data$pCO2 <- NA
completed_meso_data$pCO2insitu <- NA
completed_meso_data$HCO3 <- NA
completed_meso_data$CO3 <- NA
completed_meso_data$DIC <- NA

# Calculate carbonate system parameters
for (i in 1:nrow(completed_meso_data)) {
  pH <- completed_meso_data$pH[i] 
  TA <- completed_meso_data$TA[i]  
  Salinity <- completed_meso_data$Salinity[i] 
  Temp_C <- completed_meso_data$Temp_C[i] 
  
  carbonate_params <- carb(flag = 8, var1 = pH, var2 = TA, S = Salinity,
                            T = Temp_C, Patm = 1, P = 0, Pt = 0, Sit = 0, k1k2 = "l", kf = "pf", ks = "d",
                            pHscale = "T", b = "u74", warn = "y")
  
  completed_meso_data$pCO2[i] <- carbonate_params$pCO2
  completed_meso_data$pCO2insitu[i] <- carbonate_params$pCO2insitu
  completed_meso_data$HCO3[i] <- carbonate_params$HCO3
  completed_meso_data$CO3[i] <- carbonate_params$CO3
  completed_meso_data$DIC[i] <- carbonate_params$DIC
}

# Convert parameters to µmol/kg
completed_meso_data <- completed_meso_data %>% 
  mutate(TA = TA * 1e6,
         HCO3 = HCO3 * 1e6,
         CO3 = CO3 * 1e6,
         DIC = DIC * 1e6)

# Write the data
write_csv(completed_meso_data, here("Data", "Mesocosm_Data", "Completed_Mesocosm_Dataset_Carbonate.csv"))

# Calculate the overall mean pH
low_mean_pH <- completed_meso_data %>% 
  filter(pH_Treatment == "Low") %>%
  dplyr::summarize(Mean_pH = mean_pH(pH, na.rm = TRUE),
                   SD_pH = sd(pH, na.rm = TRUE),
                   N = n(),
                   SE = SD_pH / sqrt(N),
                   Upper_CI = Mean_pH + 1.96 * SE,
                   Lower_CI = Mean_pH - 1.96 * SE)

# Calculate the overall mean pH
ambient_mean_pH <- completed_meso_data %>% 
  filter(pH_Treatment == "Ambient") %>%
  dplyr::summarize(Mean_pH = mean(pH, na.rm = TRUE),
                   SD_pH = sd(pH, na.rm = TRUE),
                   N = n(),
                   SE = SD_pH / sqrt(N),
                   Upper_CI = Mean_pH + 1.96 * SE,
                   Lower_CI = Mean_pH - 1.96 * SE)

cat("Low pH Treatment Mean pH: ", low_mean_pH$Mean_pH, "\n")
cat("Ambient pH Treatment Mean pH: ", ambient_mean_pH$Mean_pH, "\n")

```


# Carbonate System Data Analysis 

```{r}
mesocosm.data <- read_csv(here("Data", "Mesocosm_Data", "Completed_Mesocosm_Dataset_Carbonate.csv"))
mesocosm.data<- mesocosm.data %>% 
  filter(pH_Treatment != "Sump") %>%
  mutate(pH_Treatment = as.factor(pH_Treatment))

mesocosm_pH_lm_model <- lm(pH ~ Temp_Treatment * pH_Treatment, data = completed_meso_data)
anova_mescososm_pH_results <- anova(mesocosm_pH_lm_model)
print(anova_mescososm_pH_results)
check_model(mesocosm_pH_lm_model)

# Calculate mean and standard deviation of pH by treatment
ph.data <- completed_meso_data %>%
  filter(pH_Treatment != "Sump") %>% 
  dplyr::select(pH, pH_Treatment) %>% 
  group_by(pH_Treatment) %>%
  summarize(Mean_pH = mean(pH, na.rm = TRUE),
            Sd_pH = sd(pH, na.rm = TRUE))

print(ph.data)

# Perform t-test to compare means
t_test_result <- t.test(pH ~ pH_Treatment, data = mesocosm.data)

# Print the t-test results
print(t_test_result)

# Plot the data
pH_treatment_plot <- ggplot(mesocosm.data, aes(x = pH_Treatment, y = pH, fill = pH_Treatment)) +
  geom_boxplot() +
  geom_signif(comparisons = list(c("Low", "Ambient")), 
              test = "t.test", 
              map_signif_level = TRUE, 
              textsize = 4, 
              vjust = -0.5) +
  scale_fill_manual(values = c("Low" = "cyan3", "Ambient" = "orange")) +
  scale_y_continuous(expand=c(0,0.15)) +
  labs(title = NULL,
       x = "Treatment",
       y = TeX("$pH_{T}$ (mol/kg)"),
       fill = "pH Treatment") +
  common_theme

ggsave(here("Figures", "pH_Treatment_Plot.png"), plot = pH_treatment_plot, width = 4.5, height = 4, dpi = 1300)


```




# Reading in HOBO Logger data to calculate the mescosm system treatment temperatures

```{r Proccessing HOBO Logger Data}
# Function to read and process temperature data from HOBO loggers
read_process_temp_data <- function(filename) {
  # Extract tank ID from filename
  tank_id <- sub(".*\\/(TNK-[0-9]+|TNK-[A-Z]+).*", "\\1", filename)
  # Correct tank IDs with underscores
  tank_id <- sub("-", "_", tank_id)
  # Read CSV file, skipping first two rows and renaming columns
  temp_data <- read_csv(filename, skip = 2, col_names = c("Datetime", "Temp_C", "Host Connect", "Button Down", "Button Up", "EOF"), show_col_types = FALSE) %>%
    dplyr::select(1:2) %>%  # Select only Datetime and Temp_C columns
    slice(-1) %>%            # Remove first row
    mutate(
      Datetime = ymd_hms(Datetime),        # Parse Datetime column as date-time
      Time = hms(format(Datetime, format = "%H:%M:%S")),  # Extract time component
      Temp_C = as.numeric(Temp_C),          # Convert temperature to numeric
      Tank_ID = tank_id                      # Assign Tank_ID
    )
  return(temp_data)
}

# Read and process temperature data for each tank
tank_timeseries <- list.files(here::here("Data", "Mesocosm_Data", "Mesocosm_HOBO_Temperature"), full.names = TRUE) %>%
  map_df(read_process_temp_data)

mesocosm.data <- read_csv(here::here("Data", "Mesocosm_Data", "Completed_Mesocosm_Dataset_Carbonate.csv"))

# Clean and filter temperature data
cleaned_timeseries <- tank_timeseries %>%
  group_by(Datetime = ceiling_date(Datetime, "hour"), Tank_ID) %>%  # Round Datetime to the nearest hour and group by Tank_ID
  filter(Datetime > "2022-08-16",   # Filter data from the start of the experiment
         Datetime <= "2022-09-02") %>%  # Filter data until the end of the experiment
  summarise(Avg_Temp_C = mean(Temp_C), .groups = 'drop') %>%  # Calculate average temperature per hour
  mutate(
    Tide = case_when(
      hour(Datetime) >= 13.5 & hour(Datetime) < 16.5 ~ "Low",
      hour(Datetime) >= 1.5 & hour(Datetime) < 4.5 ~ "Low",
      hour(Datetime) >= 19.5 & hour(Datetime) < 22.5 ~ "High",
      hour(Datetime) >= 7.5 & hour(Datetime) < 10.5 ~ "High",
      TRUE ~ "Intermediate"  # Add an intermediate tide for transitional periods
    )
  ) %>%
  na.omit()  # Remove rows with NA values

#filtering for water change dates and water spillage dates throuhgout the entirey of the experiment
cleaned_timeseries <- cleaned_timeseries %>%
  filter(!(Datetime >= as_datetime("2022-08-20 06:00:00") &  # 
           Datetime < as_datetime("2022-08-21 00:00:00"))) %>%
  filter(!(Datetime >= as_datetime("2022-08-23 06:00:00") &  # 
           Datetime < as_datetime("2022-08-24 00:00:00"))) %>%
  filter(!(Datetime >= as_datetime("2022-08-21 00:00:00") &   
           Datetime < as_datetime("2022-08-22 23:00:00"))) %>%
  filter(!(Datetime >= as_datetime("2022-08-25 12:00:00") &  
           Datetime < as_datetime("2022-08-26 12:00:00"))) %>% 
  filter(!(Datetime >= as_datetime("2022-08-27 06:00:00") & 
              Datetime <= as_datetime("2022-08-27 23:59:59"))) %>% 
  filter(!(Datetime >= as_datetime("2022-08-29 12:00:00") & 
              Datetime <= as_datetime("2022-08-29 23:00:00"))) 

# Plotting the Air Temperature Time Series to view Air Temp in the Mesocosm
plot_timeseries_tnk_air <- cleaned_timeseries %>%
  filter(str_detect(Tank_ID, "AIR")) %>%
  ggplot(aes(x = Datetime, y = Avg_Temp_C, color = Tide, group = Tank_ID)) +
  geom_line(color="orange") +
  facet_wrap(~Tank_ID, scales = "free_y") +
  labs(x = "Datetime", y = "Average Air Temperature (°C)",
       title = "Air Temperature Time Series for Air Logger") +
  theme_minimal() +
  guides(color = guide_legend(title = "Tide")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8))

# Plotting the Air Temperature Time Series to view Air Temp in the Mesocosm
plot_timeseries_tnk_smp <- cleaned_timeseries %>%
  filter(str_detect(Tank_ID, "SMP")) %>%
  ggplot(aes(x = Datetime, y = Avg_Temp_C, color = Tide, group = Tank_ID)) +
  geom_line(color="darkblue") +
  facet_wrap(~Tank_ID, scales = "free_y") +
  labs(x = "Datetime", y = "Average Sump Temperature (°C)",
       title = "Air Temperature Time Series for Sump Logger") +
  theme_minimal() +
  guides(color = guide_legend(title = "Tide")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8))

# Plotting the time series of air temperature with tide color
plot_timeseries_air <- cleaned_timeseries %>%
  filter(str_detect(Tank_ID, "SMP|TNK_")) %>%
  filter(Tide != "Intermediate", Tide != "High") %>%
  ggplot(aes(x = Datetime, y = Avg_Temp_C, color = Tide, group = Tank_ID)) +
  geom_line(color="gold") +
  facet_wrap(~Tank_ID, scales = "free_y") +
  labs(x = "Datetime", y = "Average Air Temperature (°C)",
       title = "Air Temperature Time Series by Tank") +
  theme_minimal() +
  guides(color = guide_legend(title = "Tide")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8))


# Plotting the time series of water temperature with tide color
plot_timeseries_water <- cleaned_timeseries %>%
  filter(str_detect(Tank_ID, "SMP|TNK_")) %>%
  filter(Tide != "Intermediate", Tide != "Low") %>%
  ggplot(aes(x = Datetime, y = Avg_Temp_C, color = Tide, group = Tank_ID)) +
  geom_line(color="cyan3") +
  facet_wrap(~Tank_ID, scales = "free_y") +
  labs(x = "Datetime", y = "Average Water Temperature (°C)",
       title = "Water Temperature Time Series by Tank") +
  theme_minimal() +
  guides(color = guide_legend(title = "Tide")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8))

# Define the order of tanks
tank_order <- c("TNK_AIR", "TNK_SMP", "TNK_9", paste0("TNK_", 2:8), "TNK_18", paste0("TNK_", 10:16))

# Plotting the boxplot for mean air and water temperature by tank, excluding intermediate tide
plot_avg_temps <- cleaned_timeseries %>%
  filter(Tide != "Intermediate") %>%
  mutate(Tank_ID = factor(Tank_ID, levels = tank_order)) %>%  # Reorder the factor levels
  ggplot(aes(x = Tank_ID, y = Avg_Temp_C, fill = Tide)) +
  geom_boxplot(outliers=FALSE) +
  labs(x = "Tank ID", y = "Average Temperature (°C)",
       title = "Average Air and Water Temperature by Tank") +
  theme_minimal() +
  scale_fill_manual(values = c("Low" = "cyan3", "High" = "gold")) +
  guides(fill = guide_legend(title = "Tide")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8))  # Adjust the size here

# Displaying  plots
print(plot_timeseries_tnk_smp)
print(plot_timeseries_tnk_air)
print(plot_timeseries_water)
print(plot_timeseries_air)
print(plot_avg_temps)

sump_avg_temp <- cleaned_timeseries %>%
  filter(Tank_ID == "TNK_SMP") %>%
  summarise(Mean_Sump_Temp_C = mean(Avg_Temp_C),
            SE_Sump_Temp_C = sd(Avg_Temp_C) / sqrt(n()))

air_avg_temp <- cleaned_timeseries %>%
  filter(Tank_ID == "TNK_AIR") %>%
  summarise(Mean_Air_Temp_C = mean(Avg_Temp_C),
            SE_Air_Temp_C = sd(Avg_Temp_C) / sqrt(n()))

cat("Mean Sump Temperature (°C) +/- SE: ",
    sump_avg_temp$Mean_Sump_Temp_C, " +/- ", sump_avg_temp$SE_Sump_Temp_C, "\n")
cat("Mean Air Temperature (°C) +/- SE: ",
    air_avg_temp$Mean_Air_Temp_C, " +/- ", air_avg_temp$SE_Air_Temp_C, "\n")

# Extract the date from Datetime column
temperature_data <- cleaned_timeseries %>%
  mutate(Date = as.Date(Datetime))

# Group by Date and Tide, then calculate the mean temperature
tide_avg_temp <- temperature_data %>%
  group_by(Date, Tide, Tank_ID) %>%
  summarise(Avg_Temp_C = mean(Avg_Temp_C)) %>%
  pivot_wider(names_from = Tide, values_from = Avg_Temp_C, names_prefix = "Mean_", values_fill = 0) %>% 
  mutate(Mean_Aquatic_Temp_Logger = Mean_High, 
         Mean_Aerial_Temp_Logger = Mean_Low) %>%
  dplyr::select(-Mean_Intermediate, -Mean_High, -Mean_Low)

mesocosm.HOBO.data <- mesocosm.data %>%
  dplyr::select(Date, Tank_ID, Temp_Treatment,  Temp_C, pH_Treatment, pH) %>% 
  left_join(tide_avg_temp, by = c("Date", "Tank_ID"))

# Convert Date to datetime and adjust time for tanks 2-9 and 18
mesocosm_data <- mesocosm.data %>%
  mutate(Date = as_datetime(Date),  # Convert Date to datetime
         Date = case_when(
           Tank_ID %in% c("TNK_2", "TNK_3", "TNK_4", "TNK_5", "TNK_6", "TNK_7", "TNK_8", "TNK_9", "TNK_18") ~ floor_date(Date, "day") + hours(9) + minutes(30),
           TRUE ~ floor_date(Date, "day") + hours(10) + minutes(30)
         ),
         Date = floor_date(Date, "hour")) # Round datetime to the nearest hour


treatments <- mesocosm_data %>%
  group_by(Tank_ID) %>% 
  summarise(Temp_Treatment = first(Temp_Treatment), 
            pH_Treatment = first(pH_Treatment))
cleaned_timeseries <- cleaned_timeseries %>%
  left_join(treatments, by = "Tank_ID") 

# Merge mesocosm_data with cleaned_timeseries based on Date and Tank_ID
combined_data <- left_join(cleaned_timeseries,  mesocosm_data,
                 by = c("Datetime" = "Date", "Tank_ID", "Temp_Treatment", "pH_Treatment")) %>% 
  filter(Tank_ID != "TNK_AIR") 
 
# Replace Avg_Temp_C with Temp_C where available
combined_data <- combined_data %>%
  mutate(Avg_Temp_C = if_else(!is.na(Temp_C), Temp_C, Avg_Temp_C)) %>%
  dplyr::select(-Temp_C) %>%  # Drop the Temp_C column
  filter(Tide == "High") %>% 
  mutate(Date = as.Date(Datetime)) %>% 
  group_by(Date, Tank_ID, Temp_Treatment, pH_Treatment) %>%
  summarize(Mean_Hightide_Temp_C = mean(Avg_Temp_C)) %>%
  mutate(Temp_Treatment = factor(Temp_Treatment),
         pH_Treatment = factor(pH_Treatment)) %>% 
  na.omit(pH_Treatment) %>% 
  arrange(Temp_Treatment)

mesocosm_data <- mesocosm_data %>% 
  mutate(Date = as.Date(Date), 
         pH_Treatment = as.factor(pH_Treatment),
         Temp_Treatment = as.factor(Temp_Treatment))

combined_mesocosm_data <- left_join(mesocosm_data, combined_data,
       by = c("Date" = "Date", "Tank_ID" = "Tank_ID", 
       "Temp_Treatment" = "Temp_Treatment", "pH_Treatment" = "pH_Treatment"))
```


```{r}


# Calculate the temperature difference between high and low tide
temp_difference <- cleaned_timeseries %>%
  filter(Tide %in% c("High", "Low"),   # Only include high and low tide data
         !is.na(Avg_Temp_C),            # Exclude NA values
         pH_Treatment != "Sump") %>%   # Exclude "Sump" pH treatment
  group_by(Temp_Treatment, pH_Treatment, Tide) %>% 
  summarize(Mean_Temp = mean(Avg_Temp_C, na.rm = TRUE)) %>%   # Calculate the mean temperature
  pivot_wider(names_from = Tide, values_from = Mean_Temp) %>%  # Reshape data to wide format
  mutate(Temp_Diff = High - Low)   # Calculate the temperature difference between high and low tide


# Calculate the average of temperature differences for each combination
temp_difference_avg <- temp_difference %>%
  ungroup() %>% 
  summarize(Average_Temp_Diff = mean(Temp_Diff),
            SD_Temp_Diff = sd(Temp_Diff),
            SE_Temp_Diff = sd(Temp_Diff) / sqrt(n()))

# Print the average
print(temp_difference_avg)

# Print the results
print(temp_difference)

temp_difference %>% 
  pull(Temp_Diff) %>%
  min()

temp_difference %>% 
  pull(Temp_Diff) %>%
  max()


min(temp_difference$Temp_Diff)
max(temp_difference$Temp_Diff)
min(temp_difference$High)
```


```{r Proccessing HOBO Logger Data}
logger_mesocosm_data <- combined_mesocosm_data %>% 
  group_by(Date, Tank_ID, Temp_Treatment, pH_Treatment) %>%
  summarise(Logger_Temp_C = mean(Mean_Hightide_Temp_C, na.rm = TRUE), pH) %>%
  filter(pH_Treatment != "Sump") %>%
  ungroup()

logger_mesocosm_data_plot <- logger_mesocosm_data %>% 
  group_by(Temp_Treatment, pH_Treatment) %>%
  summarise(Mean_Logger_Temp_C = mean(Logger_Temp_C, na.rm = TRUE),
            SE_Logger_Temp_C = sd(Logger_Temp_C, na.rm = TRUE) / sqrt(n())) %>%
  ungroup()

# Extract unique Temp_Treatment values
temp_treatment_values <- unique(logger_mesocosm_data_plot$Temp_Treatment)

# Create a data frame for horizontal lines
hline_data <- data.frame(Temp_Treatment = temp_treatment_values)
hline_data$Temp_Treatment <- as.numeric(as.character(hline_data$Temp_Treatment))

ggplot(logger_mesocosm_data, aes(x = Temp_Treatment, y = Logger_Temp_C, fill = pH_Treatment)) +
  geom_hline(data = hline_data, aes(yintercept = Temp_Treatment, color = Temp_Treatment), 
             size = 0.4) +  # Horizontal lines with color gradient
  geom_boxplot(position = position_dodge(width = 0.5), width = 0.5, outlier.shape = NA) +  # Less wide boxplot with dodge position
  scale_fill_manual(values = c("Ambient" = "orange", "Low" = "cyan3"), name = "pH Treatment") +  # Set fill colors for pH Treatment
  scale_color_gradient(low = "#ffeda0", high = "red3", name = "Temp. Treatment") +  # Color gradient for Temp_Treatment
  labs(x = "Temperature Treatment", y = "Seawater Temperature (°C)", 
       fill = "pH Treatment", title = NULL) +
  scale_y_continuous(breaks = seq(0, 30, 2), limits = c(9, 29),
                     expand = c(0,0)) +  # Set y-axis breaks
  common_theme +  # Assuming you want to use a minimal theme; replace with common_theme if you have custom settings
  theme(legend.position = "none")

mesocosm_pH_lm_model <- lm(Logger_Temp_C ~ Temp_Treatment * pH_Treatment, data = logger_mesocosm_data)
anova_mescososm_pH_results <- anova(mesocosm_pH_lm_model)
check_model(mesocosm_pH_lm_model)
mesocoswm_pH_lm_results <- summary(mesocosm_pH_lm_model)
print(mesocoswm_pH_lm_results)

# Create an empty data frame to store results
temp_difference_df <- data.frame(Temp_Treatment = character(), 
                                 pH_Treatment = character(), 
                                 Mean_Temp_Difference = numeric())

# Loop through each temperature treatment and pH treatment combination
for (temp_treatment in unique(logger_mesocosm_data$Temp_Treatment)) {
  for (pH_treatment in unique(logger_mesocosm_data$pH_Treatment)) {
    # Subset data for the current combination
    subset_data <- logger_mesocosm_data[logger_mesocosm_data$Temp_Treatment == temp_treatment & 
                                        logger_mesocosm_data$pH_Treatment == pH_treatment, ]
    
    # Calculate mean air temperature and mean water temperature for the current combination
    mean_air_temp <- mean(subset_data$Mean_Air_Temp_C)
    mean_water_temp <- mean(subset_data$Logger_Temp_C)
    
    # Calculate the mean difference between air and water temperatures
    mean_temp_difference <- mean_air_temp - mean_water_temp
    
    # Append results to the data frame
    temp_difference_df <- rbind(temp_difference_df, 
                                data.frame(Temp_Treatment = temp_treatment, 
                                           pH_Treatment = pH_treatment, 
                                           Mean_Temp_Difference = mean_temp_difference))
  }
}

# Print the results
print(temp_difference_df)
```

## Mesocosm Temperature and pH Statistical Analysis 

```{r}


mesocosm.data <- read_csv(here::here("Data", "Mesocosm_Data", "Completed_Mesocosm_Dataset_Carbonate.csv"))
mesocosm.data <- mesocosm.data %>%
  mutate(Date = as.Date(Date, format = "%m/%d/%Y")) %>%
  mutate(Temp_Treatment = as.factor(Temp_Treatment),
         pH_Treatment = as.factor(pH_Treatment)) %>% 
  filter(pH_Treatment != "Sump") # Filter out the "Sump" treatment


# include this table in the appendix through gt table 

mesocosm_pH_lm_model <- lm(pH ~ Temp_Treatment * pH_Treatment, data = mesocosm.data)
anova_mescososm_pH_results <- anova(mesocosm_pH_lm_model)
check_model(mesocosm_pH_lm_model)

```



```{r}



# Mesocosm System Data Analysis 


mesocosm.data <- read_csv(here::here("Data", "Mesocosm_Data", "Completed_Mesocosm_Dataset_Carbonate.csv"))

# Linear regression for Salinity and temperature
lm_result_temp_salinity <- lm(Salinity ~ Temp_C, data = mesocosm.data)
summary(lm_result_temp_salinity)
plot(lm_result_temp_salinity)

# Plot Temperature vs. Salinity with a linear regression line
ggplot(mesocosm.data, aes(x = Temp_C, y = Salinity)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, color="lightyellow") +
  labs(x = "Temperature (°C)", y = "Salinity (ppt)") +
  theme_minimal() +
  ggtitle("Temperature vs. Salinity")

oxygen.data <- mesocosm.data %>%
  filter(pH_Treatment != "Sump") %>% 
  dplyr::select(DO_mgL, DO_Percent, Temp_C, pH_Treatment, Temp_Treatment) %>%
  na.omit()

# Linear regression for Temperature and Dissolved Oxygen
ggplot(oxygen.data, aes(x = Temp_C, y = DO_mgL, group=pH_Treatment, color=pH_Treatment)) +
  geom_point() +
  geom_smooth(method = "lm", se = TRUE) +
  labs(x = "Temperature (°C)", y = "Dissolved Oxygen (mg/L)") +
  theme_minimal() +
  ggtitle("Temperature vs. Dissolved Oxygen")

# Linear regression for Temperature and Dissolved Oxygen
ggplot(oxygen.data, aes(x = Temp_C, y = DO_Percent, group=pH_Treatment, color=pH_Treatment)) +
  geom_point() +
  geom_smooth(method = "lm", se = TRUE) +
  labs(x = "Temperature (°C)", y = "Dissolved Oxygen (%)") +
  theme_minimal() +
  ggtitle("Temperature vs. Dissolved Oxygen")

# Oxygen saturation linear regression
lm_result_o2_temp <- lm(DO_mgL ~ Temp_C, data = oxygen.data)
summary(lm_result_o2_temp)
plot(lm_result_o2_temp)

# Get a summary of the model
model_summary <- summary(lm_result_o2_temp)

# Access and print the R-squared value
r_squared <- model_summary$r.squared
print(paste("R-squared: DO mg/L", r_squared))

lm_result_o2_temp <- lm(DO_Percent ~ Temp_C, data = oxygen.data)
summary(lm_result_o2_temp)
plot(lm_result_o2_temp)

# Get a summary of the model
model_summary <- summary(lm_result_o2_temp)

# Access and print the R-squared value
r_squared <- model_summary$r.squared
print(paste("R-squared: DO (%)", r_squared))

# Group by Temp_Treatment and pH_Treatment to find summary stats and quantiles
summary_data <- mesocosm.data %>%
  group_by(Temp_Treatment, pH_Treatment) %>%
  dplyr::summarize(
    # Calculate mean and standard deviation for Temp_C
    Mean_Temp_C = mean(Temp_C, na.rm = TRUE),
    SD_Temp_C = sd(Temp_C, na.rm = TRUE),
    SE_Temp_C = sd(Temp_C, na.rm = TRUE) / sqrt(n()),
    N = n(),
    
    # Calculate mean and standard deviation for DO_mgL
    Mean_DO_mgL = mean(DO_mgL, na.rm = TRUE),
    SD_DO_mgL = sd(DO_mgL, na.rm = TRUE),
    SE_DO_mgL = sd(DO_mgL, na.rm = TRUE) / sqrt(n()),
    N = n(),
        
    # Calculate mean and standard deviation for DO_Percent
    Mean_DO_Percent = mean(DO_Percent, na.rm = TRUE),
    SD_DO_Percent = sd(DO_Percent, na.rm = TRUE),
    SE_DO_Percent = sd(DO_Percent, na.rm = TRUE) / sqrt(n()),
    # Calculate mean and standard deviation for Salinity
    Mean_Salinity = mean(Salinity, na.rm = TRUE),
    SD_Salinity = sd(Salinity, na.rm = TRUE),
    SE_Salinity = sd(Salinity, na.rm = TRUE) / sqrt(n()),
    # Calculate mean and standard deviation for Conductivity
    Mean_Conductivity = mean(Conductivity, na.rm = TRUE),
    SD_Conductivity = sd(Conductivity, na.rm = TRUE),
    SE_Conductivity = sd(Conductivity, na.rm = TRUE) / sqrt(n()),
    # Calculate mean and standard deviation for pH
    Mean_pH = mean_pH(pH, na.rm = TRUE),
    SD_pH = sd(pH, na.rm = TRUE),
    SE_pH = sd(pH, na.rm = TRUE) / sqrt(n()),
    # Calculate mean and standard deviation for TA
    Mean_TA = mean(TA, na.rm = TRUE),
    SD_TA = sd(TA, na.rm = TRUE),
    SE_TA = sd(TA, na.rm = TRUE) / sqrt(n()),
    # Calculate mean and standard deviation for pCO2
    Mean_pCO2 = mean(pCO2, na.rm = TRUE),
    SD_pCO2 = sd(pCO2, na.rm = TRUE),
    SE_pCO2 = sd(pCO2, na.rm = TRUE) / sqrt(n()),
    # Calculate mean and standard deviation for HCO3
    Mean_HCO3 = mean(HCO3, na.rm = TRUE),
    SD_HCO3 = sd(HCO3, na.rm = TRUE),
    SE_HCO3 = sd(HCO3, na.rm = TRUE) / sqrt(n()),
    # Calculate mean and standard deviation for CO3
    Mean_CO3 = mean(CO3, na.rm = TRUE),
    SD_CO3 = sd(CO3, na.rm = TRUE),
    SE_CO3 = sd(CO3, na.rm = TRUE) / sqrt(n()),
    # Calculate mean and standard deviation for DIC
    Mean_DIC = mean(DIC, na.rm = TRUE),
    SD_DIC = sd(DIC, na.rm = TRUE),
    SE_DIC = sd(DIC, na.rm = TRUE) / sqrt(n())
) 

summary_table <- summary_data %>% 
  mutate(
    # Format columns as mean +- sd
    Mean_Temp_C = paste(round(Mean_Temp_C, 2), "±", round(SD_Temp_C, 2)),
    Mean_pH = paste(round(Mean_pH, 2), "±", round(SD_pH, 2)),
    Mean_Salinity = paste(round(Mean_Salinity, 2), "±", round(SD_Salinity, 2)),
    Mean_DO_mgL = paste(round(Mean_DO_mgL, 2), "±", round(SD_DO_mgL, 2)),
    Mean_Conductivity = paste(round(Mean_Conductivity, 2), "±", round(SD_Conductivity, 2)),
    Mean_TA = paste(round(Mean_TA, 2), "±", round(SD_TA, 2)),
    Mean_pCO2 = paste(round(Mean_pCO2, 2), "±", round(SD_pCO2, 2)),
    Mean_HCO3 = paste(round(Mean_HCO3, 2), "±", round(SD_HCO3, 2)),
    Mean_CO3 = paste(round(Mean_CO3, 2), "±", round(SD_CO3, 2)),
    Mean_DIC = paste(round(Mean_DIC, 2), "±", round(SD_DIC, 2))
  ) 

summary_table <- summary_table %>%
  dplyr::select(-SD_Temp_C, -SD_pH, -SD_Salinity, -SD_DO_Percent, -SD_DO_mgL, -SD_Conductivity, -SD_TA, -SD_pCO2, -SD_HCO3, -SD_CO3, -SD_DIC) %>%
  dplyr::select(-Mean_DO_Percent, -Mean_Conductivity) %>%
  arrange(pH_Treatment, Temp_Treatment)


summary_table <- summary_table %>%
  mutate(
    pH_Treatment = factor(pH_Treatment, levels = c("Ambient", "Low", "Sump"))
  ) %>%
  arrange(pH_Treatment, Temp_Treatment) %>% ungroup()


  
  # Assuming summary_table is already created and contains the formatted summary data
gt_summary_table <- gt(summary_table) %>%
  tab_header(
    title = md("**Summary of Treatment Conditions**"),
    subtitle = "Mean +/- SE Amongst Tmeprature and pH Treatments"
  ) %>%
  cols_label(
    Temp_Treatment = "Temp Treatment",
    pH_Treatment = "pH Treatment",
    Mean_Temp_C = "Mean Temp (°C)",
    Mean_pH = "Mean pH\u209C",
    Mean_DO_mgL = "Mean DO (mg/L)",
    Mean_Salinity = "Mean Salinity (ppt)",
    Mean_TA = "Mean TA (µmol/kg)",
    Mean_pCO2 = "Mean pCO\u2082 (µatm)",
    Mean_HCO3 = "Mean HCO\u2083 (µmol/kg)",
    Mean_CO3 = "Mean CO₃ (µmol/kg)",
    Mean_DIC = "Mean DIC (µmol/kg)"
) %>%
  gt_theme %>%
  tab_options(
    table.font.size = 12,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    table.font.color = "black",
    table.width = "150%"
  ) %>%
  tab_style(
    style = cell_text(align = "center"),
    locations = cells_body(columns = everything())
  ) %>%
  tab_style(
    style = cell_text(align = "center"),
    locations = cells_column_labels(columns = everything())
  ) %>%
  opt_table_font(
    font = "serif") %>%
    fmt_number(
    columns = everything(),
    decimals = 2) %>% 
  tab_style(
    style=list(cell_text(align = "center",
                      font = "serif", weight="bolder",
                      size = 16, color = "black"), 
        cell_fill(color = "grey50", alpha = 0.01),
        cell_borders(
        sides = "top", 
        color = "black",
        weight = px(2)
        )),
    locations = cells_title(groups = "title")
  ) %>%
  tab_style(
    style=list(cell_text(align = "center",
                      font = "serif",
                      size = 14, color = "black", weight="bold"), 
        cell_fill(color = "grey50", alpha = 0.01),
        cell_borders(
        sides = "bottom", 
        color = "black",
        weight = px(2)
        )),
    locations = cells_title(groups = "subtitle")
  ) %>%
    tab_style(
    style = cell_text(align = "center", font = "serif", weight="bold", size = 12, color = "black"),
    locations = cells_column_labels(columns = everything()) 
  ) %>%
  tab_style(
    style = cell_text(align = "center", font = "serif", size = 12, color = "black"),
    locations = cells_body()
  ) %>% 
  tab_options(
    table.width = pct(150),
    table.border.top.width = px(1),
    table.border.top.color = "black",
    table.border.bottom.color = "black",
    table.border.bottom.width = px(2),
    table_body.border.bottom.width = px(2),
    table_body.border.bottom.color = "black",
    table_body.border.top.width = px(2),
    table_body.border.top.color = "black",
    table_body.hlines.width = px(0.5),
    table_body.hlines.color = "grey90",
    column_labels.background.color = "white",
    column_labels.border.top.width = px(2),
    column_labels.border.top.color = "black",
    column_labels.border.bottom.width = px(2),
    column_labels.border.bottom.color = "black",
    row_group.border.top.width = px(1.25),
    row_group.border.top.color = "black",
    row_group.border.bottom.width = px(1.25),
    row_group.border.bottom.color = "black",
    source_notes.font.size = 12,
    table.font.size = 12,
    heading.title.font.size = 14,
    heading.subtitle.font.size = 12,
    heading.align = "center",
    heading.padding = px(5),
    row_group.padding = px(1),
    data_row.padding = px(1)) 
# Save the summary table as an image file
gtsave(gt_summary_table, filename = here("Figures", "summary_table.png"))

# Display the table in the R session for verification
gt_summary_table
  
#save summary table in csv format
write_csv(summary_data, here("Figures", "mesocosm_summary_table.csv"))

#read csv file
read_csv(here("Output", "mesocosm_summary_table.csv")) 
```


```





# Plotting the Mesocosm Variables

```{r}

# Create a plot with standard error bars for Mean_DO_mgL
mesocosm_plot_do <- ggplot(summary_data, aes(x = factor(Temp_Treatment), y = Mean_DO_mgL, color = factor(pH_Treatment))) +
  geom_point(position = position_dodge(0.75), size = 2) +
  geom_errorbar(
    aes(ymin = Mean_DO_mgL - SD_DO_mgL, ymax = Mean_DO_mgL + SD_DO_mgL),
    width = 0.2,
    position = position_dodge(0.75),
    size = 1
  ) +
  labs(
    x = "Temp Treatment",
    y = "Mean DO (mg/L)",
    color = "pH Treatment"
  ) +
  ggtitle("Mean DO (mg/L) by pH Treatment (Mean DO +/- SE)") +
  scale_color_manual(values = c("Ambient" = "orange", "Low" = "cyan3")) +  # Specify colors as needed
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"))  # Center and bold the title

# Create a plot with standard error bars for Mean_DO_Percent
mesocosm_plot_do_percent <- ggplot(summary_data, aes(x = factor(Temp_Treatment), y = Mean_DO_Percent, color = factor(pH_Treatment))) +
  geom_point(position = position_dodge(0.75), size = 2) +
  geom_errorbar(
    aes(ymin = Mean_DO_Percent - SD_DO_Percent, ymax = Mean_DO_Percent + SD_DO_Percent),
    width = 0.2,
    position = position_dodge(0.75),
    size = 1
  ) +
  labs(
    x = "Temp Treatment",
    y = "Mean DO %",
    color = "pH Treatment"
  ) +
  ggtitle("Mean DO % by pH Treatment (Mean DO +/- SE)") +
  scale_color_manual(values = c("Ambient" = "orange", "Low" = "cyan3")) +  # Specify colors as needed
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"))  # Center and bold the title

# Create a plot with standard error bars for Mean_Salinity
mesocosm_plot_salinity <- ggplot(summary_data, aes(x = factor(Temp_Treatment), y = Mean_Salinity, color = factor(pH_Treatment))) +
  geom_point(position = position_dodge(0.75), size = 2) +
  geom_errorbar(
    aes(ymin = Mean_Salinity - SD_Salinity, ymax = Mean_Salinity + SD_Salinity),
    width = 0.2,
    position = position_dodge(0.75),
    size = 1
  ) +
  labs(
    x = "Temp Treatment",
    y = "Mean Salinity",
    color = "pH Treatment"
  ) +
  ggtitle("Mean Salinity by pH Treatment (Mean Salinity +/- SE)") +
  scale_color_manual(values = c("Ambient" = "orange", "Low" = "cyan3")) +  # Specify colors as needed
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"))  # Center and bold the title

# Create a plot with standard error bars for Mean_Conductivity
mesocosm_plot_conductivity <- ggplot(summary_data, aes(x = factor(Temp_Treatment), y = Mean_Conductivity, color = factor(pH_Treatment))) +
  geom_point(position = position_dodge(0.75), size = 2) +
  geom_errorbar(
    aes(ymin = Mean_Conductivity - SD_Conductivity, ymax = Mean_Conductivity + SD_Conductivity),
    width = 0.2,
    position = position_dodge(0.75),
    size = 1
  ) +
  labs(
    x = "Temp Treatment",
    y = "Mean Conductivity",
    color = "pH Treatment"
  ) +
  ggtitle("Mean Conductivity by pH Treatment (Mean Conductivity +/- SE)") +
  scale_color_manual(values = c("Ambient" = "orange", "Low" = "cyan3")) +  # Specify colors as needed
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"))  # Center and bold the title


# Create a plot with standard error bars for Mean_Temp_C
mesocosm_plot_temp <- ggplot(summary_data, aes(x = factor(Temp_Treatment), y = Mean_Temp_C, color = factor(pH_Treatment))) +
  geom_point(position = position_dodge(0.75), size = 2) +
  geom_errorbar(
    aes(ymin = Mean_Temp_C - SD_Temp_C, ymax = Mean_Temp_C + SD_Temp_C),
    width = 0.2,
    position = position_dodge(0.75),
    size = 1
  ) +
  geom_hline(yintercept = c(12, 14, 16, 18, 20, 22, 24, 26), linetype = "dashed") +
  labs(
    x = "Temp Treatment",
    y = "Mean Temp (°C)",
    color = "pH Treatment"
  ) +
  ggtitle("Mean Temperature by pH Treatment (Mean Temp +/- SE)") +
  scale_color_manual(values = c("Ambient" = "orange", "Low" = "cyan3")) +  # Specify orange and cyan as colors
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"))  # Center and bold the title


# Create a plot with standard error bars for Mean_pH
mesocosm_plot_pH <- ggplot(summary_data, aes(x = factor(Temp_Treatment), y = Mean_pH, color = factor(pH_Treatment))) +
  geom_point(position = position_dodge(0.75), size = 2) +
  geom_errorbar(
    aes(ymin = Mean_pH - SD_pH, ymax = Mean_pH + SD_pH),
    width = 0.2,
    position = position_dodge(0.75),
    size = 1
  ) +
  geom_hline(yintercept = c(7.7, 8.0), linetype = "dashed", color = c("cyan3", "orange")) +
  labs(
    x = "Temp Treatment",
    y = "Mean pH",
    color = "pH Treatment"
  ) +
  ggtitle("Mean pH by Treatment (Mean pH +/- SE)") +
  scale_color_manual(values = c("Ambient" = "orange", "Low" = "cyan3", "Sump"="grey")) +  # Specify colors as needed
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"))  # Center and bold the title

# Create a point plot with error bars for Mean pH and SE, colored in orange and cyan3
mesocosm_mean_pH_plot <- ggplot(summary_data, aes(x = pH_Treatment, y = Mean_pH, color = pH_Treatment)) +
  geom_point(position = position_dodge(width = 0.2), size = 3) +
  geom_errorbar(aes(ymin = Mean_pH - SD_pH, ymax = Mean_pH + SD_pH, color = pH_Treatment), position = position_dodge(width = 0.2), width = 0.2) +
  labs(title = "pH Treatment Summary (Mean pH +/- SE)",
       x = "pH Treatment",
       y = "Mean pH",
       color = "pH Treatment") +
  theme_minimal() +
  scale_color_manual(values = c("orange", "cyan3", "grey")) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"))  # Center and bold the title

# Display the plots
print(mesocosm_plot_do)
print(mesocosm_plot_do_percent)
print(mesocosm_plot_conductivity)
print(mesocosm_plot_salinity)
print(mesocosm_plot_temp)
print(mesocosm_plot_pH)
print(mesocosm_mean_pH_plot)

# Saving Plots to Output Folder 

ggsave(here("Output/mesocosm_plot_do.png"), mesocosm_plot_do, width = 8, height = 6)
ggsave(here("Output/mesocosm_plot_do_percent.png"), mesocosm_plot_do_percent, width = 8, height = 6)
ggsave(here("Output/mesocosm_plot_conductivity.png"), mesocosm_plot_conductivity, width = 8, height = 6)
ggsave(here("Output/mesocosm_plot_salinity.png"), mesocosm_plot_salinity, width = 8, height = 6)
ggsave(here("Output/mesocosm_plot_temp.png"), mesocosm_plot_temp, width = 8, height = 6)
ggsave(here("Output/mesocosm_plot_pH.png"), mesocosm_plot_pH, width = 8, height = 6)
ggsave(here("Output/mesocosm_mean_pH_plot.png"), mesocosm_mean_pH_plot, width = 8, height = 6)

```

```{r}

pH_Temp_data <- mesocosm.data %>%
  filter(pH_Treatment != "Sump") %>% 
  dplyr::select(pH_Treatment, Temp_Treatment, Mean_Temp_C, SE_Temp_C, Mean_pH, SD_pH) %>%
  na.omit()



# Create a new variable for dodging manually
pH_Temp_data$Temp_Treatment_Offset <- as.numeric(pH_Temp_data$Temp_Treatment)
# Apply a different offset for each pH_Treatment
pH_Temp_data$Temp_Treatment_Offset <- ifelse(pH_Temp_data$pH_Treatment == "Low",
                                              pH_Temp_data$Temp_Treatment_Offset - 0.2,
                                              pH_Temp_data$Temp_Treatment_Offset + 0.2)


# First, create a data frame with the y-intercepts and corresponding colors
hline_data <- data.frame(
  yintercept = seq(12, 26, by = 2),
  Temp_Treatment = seq(12, 26, by = 2)  # This should match your Temp_Treatment variable
)

# Then map the colors to this new data within geom_hline()
mesocosm_plot_temp_pub <- ggplot(pH_Temp_data, aes(x = Temp_Treatment_Offset, y = Mean_Temp_C)) +
  geom_errorbar(
    aes(ymin = Mean_Temp_C - SE_Temp_C, ymax = Mean_Temp_C + SE_Temp_C, size = as.factor(pH_Treatment)),
    width = 0.1
  ) +
  geom_point(aes(color = as.numeric(Temp_Treatment)), size = 2) +
  scale_color_gradient(low = "#ffffcc", high = "red3", name = "Temp (°C)", limits = c(12, 26), breaks = seq(12, 26, by = 2)) +
  scale_size_manual(values = c(0.5, 1), name = "pH Treatment") +
  scale_x_continuous(breaks = seq(12, 26, by = 2), limits = c(11, 27)) +
  scale_y_continuous(breaks = seq(12, 26, by = 2), limits = c(11, 27)) +
  labs(x = "Temp Treatment", y = "Mean Temp (°C)") +
  common_theme +
  theme(
    text = element_text(family = "Times New Roman", size = 12),
    axis.title = element_text(size = 12),
    legend.position = "none"
  )

# Create a plot with standard error bars for Mean_pH
mesocosm_plot_pH_pub <- ggplot(pH_Temp_data, aes(x = factor(Temp_Treatment), y = Mean_pH, color = factor(pH_Treatment))) +
  geom_point(position = position_dodge(0.75), size = 2) +
  geom_errorbar(
    aes(ymin = Mean_pH - SD_pH, ymax = Mean_pH + SD_pH),
    width = 0.2,
    position = position_dodge(0.75),
    size = 1
  ) +
  geom_hline(aes(yintercept = ambient_mean_pH$Mean_pH), linetype = "dashed", color = c("darkcyan")) +
  geom_hline(aes(yintercept = low_mean_pH$Mean_pH), linetype = "dashed", color = c("cyan3")) +
  # Add shaded confidence intervals for the overall means
  #geom_ribbon(data = mean_pH_data, aes(ymin = Lower_CI, ymax = Upper_CI), alpha = 0.25) +
  labs(x = "Temp Treatment",
    y = "Mean pH",
    color = "pH Treatment"
  ) +
  scale_color_manual(values = c("Ambient" = "darkcyan", "Low" = "cyan3")) +  # Specify colors as needed
  theme_classic() +
  theme(text = element_text(family = "Times New Roman", size = 12),
        axis.title = element_text(size = 12),
        legend.position = "right") 



# Create a point plot with error bars for Mean pH and SE, colored in orange and cyan3
mesocosm_mean_pH_plot_pub <- ggplot(pH_Temp_data, aes(x = pH_Treatment, y = Mean_pH, color = pH_Treatment)) +
  geom_hline(aes(yintercept = ambient_mean_pH$Mean_pH), linetype = "dashed", color = c("darkcyan")) +
  geom_hline(aes(yintercept = low_mean_pH$Mean_pH), linetype = "dashed", color = c("cyan3")) +
  geom_point(position = position_dodge(width = 0.2), size = 3) +
  geom_errorbar(aes(ymin = Mean_pH - SD_pH, ymax = Mean_pH + SD_pH, color = pH_Treatment), position = position_dodge(width = 0.2), width = 0.2) +
  labs(x = "pH Treatment",
       y = "Mean pH",
       color = "pH Treatment") +
  theme_classic() +
  scale_color_manual(values = c("darkcyan", "cyan3")) +
  theme(text = element_text(family = "Times New Roman", size = 12),
        axis.title = element_text(size = 12),
        legend.position = "right")  # Center and bold the title

# Display the plots
print(mesocosm_plot_temp_pub)
print(mesocosm_plot_pH_pub)
print(mesocosm_mean_pH_plot_pub)

```

```{r}


# Filter out rows where pH_Treatment is not equal to "Sump"
temp_summary_data <- mesocosm.data%>%
  filter(pH_Treatment != "Sump") %>% 
  dplyr::select(Mean_Temp_C, Temp_Treatment, pH_Treatment)

temp_summary_data$Temp_Treatment <- as.factor(temp_summary_data$Temp_Treatment)
temp_summary_data$pH_Treatment <- as.factor(temp_summary_data$pH_Treatment)
# Perform ANOVA
anova_result <- aov(Mean_Temp_C ~ Temp_Treatment * pH_Treatment, data = temp_summary_data)

# Conduct Tukey's HSD test
tukey_result <- TukeyHSD(anova_result)

# Print ANOVA table
print(anova_result)

# Print Tukey's HSD test results
print(tukey_result)

# Filter out rows where pH_Treatment is not equal to "Sump"
pH_summary_data <- summary_data %>%
  filter(pH_Treatment != "Sump") %>% 
  dplyr::select(Mean_pH=Mean_pH, Temp_Treatment, pH_Treatment)

pH_summary_data$Temp_Treatment <- as.factor(pH_summary_data$Temp_Treatment)
pH_summary_data$pH_Treatment <- as.factor(pH_summary_data$pH_Treatment)
# Perform ANOVA
anova_result <- aov(Mean_pH ~ Temp_Treatment * pH_Treatment, data = pH_summary_data)

# Conduct Tukey's HSD test
tukey_result <- TukeyHSD(anova_result)

# Print ANOVA table
print(anova_result)

# Print Tukey's HSD test results
print(tukey_result)
```


### Mesocosm Logger Time Series Data ###


```{r}
#Reading in CSV
mesocosm.metadata <- read_csv(here("Data", "Mesocosm_Data", "Mesocosm_Metadata.csv"))

#Reading in CSV
TNK_2 <- read_csv(
  here::here("Data", "Mesocosm_Data", "Mesocosm_HOBO_Temperature", "TNK-2-SN20565253 2022-09-03 20_17_13 -0700.csv"),
  skip = 2,
  col_names = c("Datetime", "Temp_C", "Host Connect", "Button Down", "Button Up", "EOF")
) %>%
  dplyr::select(1:2)%>%
  slice(-1) %>% 
  mutate(Datetime = ymd_hms(Datetime),
         Time = hms(format(Datetime, format = "%H:%M:%S")),
         Temp_C= as.numeric(Temp_C),
         Tank_ID = "TNK_2")

TNK_3 <- read_csv(
  here::here("Data", "Mesocosm_Data", "Mesocosm_HOBO_Temperature", "TNK-3-SN20565265 2022-09-03 20_18_14 -0700.csv"),
  skip = 2,
  col_names = c("Datetime", "Temp_C", "Host Connect", "Button Down", "Button Up", "EOF")
) %>%
  dplyr::select(1:2)%>%
  slice(-1) %>% 
  mutate(Datetime = ymd_hms(Datetime),
         Time = hms(format(Datetime, format = "%H:%M:%S")),
         Temp_C= as.numeric(Temp_C),
         Tank_ID = "TNK_3")

TNK_4 <- read_csv(
  here::here("Data", "Mesocosm_Data", "Mesocosm_HOBO_Temperature", "TNK-4-SN20565252 2022-09-03 20_19_11 -0700.csv"),
  skip = 2,
  col_names = c("Datetime", "Temp_C", "Host Connect", "Button Down", "Button Up", "EOF")
) %>%
  dplyr::select(1:2)%>%
  slice(-1) %>% 
  mutate(Datetime = ymd_hms(Datetime),
         Time = hms(format(Datetime, format = "%H:%M:%S")),
         Temp_C= as.numeric(Temp_C),
         Tank_ID = "TNK_4")

TNK_5 <- read_csv(
  here::here("Data", "Mesocosm_Data", "Mesocosm_HOBO_Temperature", "TNK-5-SN20569922 2022-09-03 20_20_18 -0700.csv"),
  skip = 2,
  col_names = c("Datetime", "Temp_C", "Host Connect", "Button Down", "Button Up", "EOF")
) %>%
  dplyr::select(1:2)%>%
  slice(-1) %>% 
  mutate(Datetime = ymd_hms(Datetime),
         Time = hms(format(Datetime, format = "%H:%M:%S")),
         Temp_C= as.numeric(Temp_C),
         Tank_ID = "TNK_5")

TNK_6 <- read_csv(
  here::here("Data", "Mesocosm_Data", "Mesocosm_HOBO_Temperature", "TNK-6-SN20565263 2022-09-03 20_21_26 -0700.csv"),
  skip = 2,
  col_names = c("Datetime", "Temp_C", "Host Connect", "Button Down", "Button Up", "EOF")
) %>%
  dplyr::select(1:2)%>%
  slice(-1) %>% 
  mutate(Datetime = ymd_hms(Datetime),
         Time = hms(format(Datetime, format = "%H:%M:%S")),
         Temp_C= as.numeric(Temp_C),
         Tank_ID = "TNK_6")

TNK_7 <- read_csv(
  here::here("Data", "Mesocosm_Data", "Mesocosm_HOBO_Temperature", "TNK-7-SN20714140 2022-09-03 20_23_13 -0700.csv"),
  skip = 2,
  col_names = c("Datetime", "Temp_C", "Host Connect", "Button Down", "Button Up", "EOF")
) %>%
  dplyr::select(1:2)%>%
  slice(-1) %>% 
  mutate(Datetime = ymd_hms(Datetime),
         Time = hms(format(Datetime, format = "%H:%M:%S")),
         Temp_C= as.numeric(Temp_C),
         Tank_ID = "TNK_7")

TNK_8 <- read_csv(
  here::here("Data", "Mesocosm_Data", "Mesocosm_HOBO_Temperature", "TNK-8-SN20565261 2022-09-03 20_24_16 -0700.csv"),
  skip = 2,
  col_names = c("Datetime", "Temp_C", "Host Connect", "Button Down", "Button Up", "EOF")
) %>%
  dplyr::select(1:2)%>%
  slice(-1) %>% 
  mutate(Datetime = ymd_hms(Datetime),
         Time = hms(format(Datetime, format = "%H:%M:%S")),
         Temp_C= as.numeric(Temp_C),
         Tank_ID = "TNK_8")

TNK_9 <- read_csv(
  here::here("Data", "Mesocosm_Data", "Mesocosm_HOBO_Temperature", "TNK-9-SN20565255 2022-09-03 20_25_16 -0700.csv"),
  skip = 2,
  col_names = c("Datetime", "Temp_C", "Host Connect", "Button Down", "Button Up", "EOF")
) %>%
  dplyr::select(1:2)%>%
  slice(-1) %>% 
  mutate(Datetime = ymd_hms(Datetime),
         Time = hms(format(Datetime, format = "%H:%M:%S")),
         Temp_C= as.numeric(Temp_C),
         Tank_ID = "TNK_9")

TNK_10 <- read_csv(
  here::here("Data", "Mesocosm_Data", "Mesocosm_HOBO_Temperature", "TNK-10-SN20714141 2022-09-03 20_26_26 -0700.csv"),
  skip = 2,
  col_names = c("Datetime", "Temp_C", "Host Connect", "Button Down", "Button Up", "EOF")
) %>%
  dplyr::select(1:2)%>%
  slice(-1) %>% 
  mutate(Datetime = ymd_hms(Datetime),
         Time = hms(format(Datetime, format = "%H:%M:%S")),
         Temp_C= as.numeric(Temp_C),
         Tank_ID = "TNK_10")

TNK_11 <- read_csv(
  here::here("Data", "Mesocosm_Data", "Mesocosm_HOBO_Temperature", "TNK-11-SN20565260 2022-09-03 20_27_21 -0700.csv"),
  skip = 2,
  col_names = c("Datetime", "Temp_C", "Host Connect", "Button Down", "Button Up", "EOF")
) %>%
  dplyr::select(1:2)%>%
  slice(-1) %>% 
  mutate(Datetime = ymd_hms(Datetime),
         Time = hms(format(Datetime, format = "%H:%M:%S")),
         Temp_C= as.numeric(Temp_C),
         Tank_ID = "TNK_11")

TNK_12 <- read_csv(
  here::here("Data", "Mesocosm_Data", "Mesocosm_HOBO_Temperature", "TNK-12-SN20565262 2022-09-03 20_29_03 -0700.csv"),
  skip = 2,
  col_names = c("Datetime", "Temp_C", "Host Connect", "Button Down", "Button Up", "EOF")
) %>%
  dplyr::select(1:2)%>%
  slice(-1) %>% 
  mutate(Datetime = ymd_hms(Datetime),
         Time = hms(format(Datetime, format = "%H:%M:%S")),
         Temp_C= as.numeric(Temp_C),
         Tank_ID = "TNK_12")

TNK_13 <- read_csv(
  here::here("Data", "Mesocosm_Data", "Mesocosm_HOBO_Temperature", "TNK-13-SN20714139 2022-09-03 20_30_01 -0700.csv"),
  skip = 2,
  col_names = c("Datetime", "Temp_C", "Host Connect", "Button Down", "Button Up", "EOF")
) %>%
  dplyr::select(1:2)%>%
  slice(-1) %>% 
  mutate(Datetime = ymd_hms(Datetime),
         Time = hms(format(Datetime, format = "%H:%M:%S")),
         Temp_C= as.numeric(Temp_C),
         Tank_ID = "TNK_13")

TNK_14 <- read_csv(
  here::here("Data", "Mesocosm_Data", "Mesocosm_HOBO_Temperature", "TNK-14-SN20565254 2022-09-03 20_31_00 -0700.csv"),
  skip = 2,
  col_names = c("Datetime", "Temp_C", "Host Connect", "Button Down", "Button Up", "EOF")
) %>%
  dplyr::select(1:2)%>%
  slice(-1) %>% 
  mutate(Datetime = ymd_hms(Datetime),
         Time = hms(format(Datetime, format = "%H:%M:%S")),
         Temp_C= as.numeric(Temp_C),
         Tank_ID = "TNK_14")

TNK_15 <- read_csv(
  here::here("Data", "Mesocosm_Data", "Mesocosm_HOBO_Temperature", "TNK-15-SN20565250 2022-09-03 20_16_18 -0700.csv"),
  skip = 2,
  col_names = c("Datetime", "Temp_C", "Host Connect", "Button Down", "Button Up", "EOF")
) %>%
  dplyr::select(1:2)%>%
  slice(-1) %>% 
  mutate(Datetime = ymd_hms(Datetime),
         Time = hms(format(Datetime, format = "%H:%M:%S")),
         Temp_C= as.numeric(Temp_C),
         Tank_ID = "TNK_15")

TNK_16 <- read_csv(
  here::here("Data", "Mesocosm_Data", "Mesocosm_HOBO_Temperature", "TNK-16-SN20569983 2022-09-03 20_32_03 -0700.csv"),
  skip = 2,
  col_names = c("Datetime", "Temp_C", "Host Connect", "Button Down", "Button Up", "EOF")
) %>%
  dplyr::select(1:2)%>%
  slice(-1) %>% 
  mutate(Datetime = ymd_hms(Datetime),
         Time = hms(format(Datetime, format = "%H:%M:%S")),
         Temp_C= as.numeric(Temp_C),
         Tank_ID = "TNK_16")

TNK_18 <- read_csv(
  here::here("Data", "Mesocosm_Data", "Mesocosm_HOBO_Temperature", "TNK-18-SN20569985 2022-09-03 20_35_53 -0700.csv"),
  skip = 2,
  col_names = c("Datetime", "Temp_C", "Host Connect", "Button Down", "Button Up", "EOF")
) %>%
  dplyr::select(1:2)%>%
  slice(-1) %>% 
  mutate(Datetime = ymd_hms(Datetime),
         Time = hms(format(Datetime, format = "%H:%M:%S")),
         Temp_C= as.numeric(Temp_C),
         Tank_ID = "TNK_18")

TNK_AIR <- read_csv(
  here::here("Data", "Mesocosm_Data", "Mesocosm_HOBO_Temperature", "TNK-AIR-SN20565251 2022-09-03 20_14_50 -0700.csv"),
  skip = 2,
  col_names = c("Datetime", "Temp_C", "Host Connect", "Button Down", "Button Up", "EOF")
) %>%
  dplyr::select(1:2)%>%
  slice(-1) %>% 
  mutate(Datetime = ymd_hms(Datetime),
         Time = hms(format(Datetime, format = "%H:%M:%S")),
         Temp_C= as.numeric(Temp_C),
         Tank_ID = "TNK_AIR")

TNK_SMP <- read_csv(
  here::here("Data", "Mesocosm_Data", "Mesocosm_HOBO_Temperature", "TNK-SMP-SN20569984 2022-09-03 20_33_58 -0700.csv"),
  skip = 2,
  col_names = c("Datetime", "Temp_C", "Host Connect", "Button Down", "Button Up", "EOF")
) %>%
  dplyr::select(1:2)%>%
  slice(-1) %>% 
  mutate(Datetime = ymd_hms(Datetime),
         Time = hms(format(Datetime, format = "%H:%M:%S")),
         Temp_C= as.numeric(Temp_C),
         Tank_ID = "TNK_SMP")


tank_timeseries <- bind_rows(TNK_2, TNK_3, TNK_4, TNK_5, TNK_6, TNK_7, TNK_8, TNK_9, TNK_10, TNK_11, TNK_12, TNK_13, TNK_14, TNK_15, TNK_16, TNK_18, TNK_AIR, TNK_SMP)

cleaned_timeseries <- tank_timeseries %>%
  group_by(Tank_ID) %>%
  filter(Datetime >= "2022-08-21", #day experiment began - not counting acclimation period
         Datetime <= "2022-09-01") %>% 
mutate(
    Tide = case_when(
      Time > hms("13:00:00") & Time < hms("17:00:00") ~ "Low",
      Time > hms("01:00:00") & Time < hms("05:00:00") ~ "Low",
      Time > hms("19:00:00") & Time < hms("23:00:00") ~ "High",
      Time > hms("07:00:00") & Time < hms("11:00:00") ~ "High",
      TRUE ~ "Intermediate"  # Add an intermediate tide for transitional periods
    )
  ) %>%
  na.omit() 



```


```{r}
mesocosm.data <- read_csv(here::here("Data", "Mesocosm_Data", "Completed_Mesocosm_Dataset_Carbonate.csv"))

#spot check times and values
mesocosm.data<- mesocosm.data %>%
  mutate(Datetime = ifelse(pH_Treatment == "Low", 
                      ymd_hms(paste0(Date, " 10:00:00"), tz = "UTC"), 
                      ymd_hms(paste0(Date, " 11:00:00"), tz = "UTC")),
    Datetime = as.POSIXct(Datetime)) %>%
  dplyr::select(Datetime, Tank_ID, Temp_C_Spot=Temp_C) %>%
  na.omit()

# join the time series and the spot check data 
filtered_timeseries <- filtered_timeseries %>%
  left_join(mesocosm.data, by = c("Datetime", "Tank_ID")) %>% 
  mutate(Date = as.Date(Datetime)) %>% 
  filter(Datetime >= "2022-08-23", #day experiment began - not counting acclimation period
         Datetime <= "2022-09-01")

difference <- filtered_timeseries %>%
  filter(!is.na(Temp_C_Spot)) %>%
  group_by(Tank_ID, Date) %>%
  dplyr::summarize(Temp_Diff = mean(Temp_C - Temp_C_Spot, na.rm = TRUE))

# 2. Apply the difference to correct the values in the time series data
tank_timeseries_corrected <- filtered_timeseries %>%
  left_join(difference, by = c("Tank_ID", "Date")) %>%
  mutate(Temp_C_Corrected = Temp_C - Temp_Diff)

# 3. Create a plot of the corrected temperature values
logger.temp.plot <- ggplot(tank_timeseries_corrected, aes(x = Datetime, y = Temp_C_Corrected)) +
  geom_point(aes(color = Tide), na.rm = TRUE) +
  geom_hline(aes(yintercept = Temp_Treatment)) +
  facet_wrap(~Tank_ID) +
  scale_color_discrete(name = "Tank") +
  scale_y_continuous(breaks = seq(12, 36, by = 4)) +
  labs(
    title = "Mesocosm Temperature Range",
    x = "Date",
    y = "Temperature (°C)"
  ) +
  theme_minimal() +
  theme(
    text = element_text(family = "Helvetica", size = 5, color = "black"),
    legend.title = element_text(size = 5),
    plot.title = element_text(face = "bold", hjust = 0.5)  # Bold and centered title
  )
logger.temp.plot

logger.hightide.temp <- tank_timeseries_corrected %>% 
  filter(Tide == "High") %>%
    filter(Date != "2022-08-29",
           Date != "2022-08-27") #water spillage dates (increase in watertemp not experienced)

logger.lowtide.temp.plot <- ggplot(logger.hightide.temp, aes(x = Datetime, y = Temp_C_Corrected)) +
  geom_point() +
  geom_hline(aes(yintercept = Temp_Treatment)) +
  facet_wrap(~Tank_ID) +
  scale_color_discrete(name = "Tank") +
  scale_y_continuous(breaks = seq(12, 36, by = 4)) +
  labs(
    title = "Mesocosm Temperature Range",
    x = "Date",
    y = "Temperature (°C)"
  ) +
  theme_minimal() +
  theme(
    text = element_text(family = "Helvetica", size = 5, color = "black"),
    legend.title = element_text(size = 5),
    plot.title = element_text(face = "bold", hjust = 0.5)  # Bold and centered title
  )

logger.lowtide.temp.plot 

tank_timeseries_corrected <- logger.hightide.temp


logger.hightide.temp.means <- logger.hightide.temp %>% 
  filter(pH_Treatment != "Sump", pH_Treatment != "Air") %>% 
  group_by(Temp_Treatment, pH_Treatment) %>%
  dplyr::summarize(Mean_Temp_C = mean(Temp_C, na.rm = TRUE),
                   SD_Temp_C = sd(Temp_C, na.rm = TRUE),
                   SE_Temp_C = SD_Temp_C / sqrt(n()))

# Then map the colors to this new data within geom_hline()
mesocosm_plot_temp_pub <- ggplot(logger.hightide.temp.means, aes(x = Temp_Treatment, y = Mean_Temp_C, color=pH_Treatment)) +
  # position dodge here
  geom_point(size = 2) +
  geom_errorbar(
    aes(ymin = Mean_Temp_C - SD_Temp_C, ymax = Mean_Temp_C + SD_Temp_C),
    width = 0.1,
    size = 0.75
  ) +
  scale_color_manual(values = c("darkorange", "cyan3")) +
  labs(x = "Temperature Treatment", y = "Mean Temp (°C)", color = "Temp (°C)") +
  theme_classic() +
  theme(
    text = element_text(family = "Times New Roman", size = 12),
    axis.title = element_text(size = 12),
    legend.position = "right"
  )
```


```{r}
# 1. Calculate the mean for each combination of Tank_Treatment and pH_Treatment
means <- tank_timeseries_corrected %>%
  filter(pH_Treatment != "Sump", pH_Treatment != "Air") %>% 
  group_by(Temp_Treatment, pH_Treatment) %>%
  dplyr::summarize(Mean_Temp_C = mean(Temp_C_Corrected, na.rm = TRUE),
                   SD_Temp_C = sd(Temp_C_Corrected, na.rm = TRUE))

# 2. Compute the IQR for each combination
iqr_values <- tank_timeseries_corrected %>%
  group_by(Temp_Treatment, pH_Treatment) %>%
  dplyr::summarize(Q1 = quantile(Temp_C_Corrected, 0.25, na.rm = TRUE),
            Q3 = quantile(Temp_C_Corrected, 0.75, na.rm = TRUE),
            IQR = Q3 - Q1)

# 3. Filter out values that fall outside a certain range defined by the IQR
filtered_data <- tank_timeseries_corrected %>%
  left_join(iqr_values, by = c("Temp_Treatment", "pH_Treatment")) %>%
  filter(Temp_C_Corrected >= Q1 - 1.5 * IQR, Temp_C_Corrected <= Q3 + 1.5 * IQR)

filtered_means <- filtered_data %>%
  filter(pH_Treatment != "Sump", pH_Treatment != "Air") %>%
  filter(Tide == "High") %>%
  group_by(Temp_Treatment, pH_Treatment) %>%
  dplyr::summarize(Mean_Temp_C = mean(Temp_C_Corrected, na.rm = TRUE))

write_csv(filtered_means, here::here("Data", "Mesocosm_Data", "Mesocosm_Temp_Filtered_Means.csv"))
write_csv(means, here::here("Data", "Mesocosm_Data", "Mesocosm_Temp_Means.csv"))

print(filtered_means)
print(means)
 
#means <- means %>% 
  #mutate(Temp_Treatment= case_when(
   # pH_Treatment == "Low" ~ Temp_Treatment - 0.2,
   # pH_Treatment == "Ambient" ~ Temp_Treatment + 0.2
  #))

# First, create a data frame with the y-intercepts and corresponding colors
hline_data <- data.frame(
  yintercept = seq(12, 26, by = 2),
  Temp_Treatment = seq(12, 26, by = 2)  # This should match your Temp_Treatment variable
)

# Then map the colors to this new data within geom_hline()
mesocosm_plot_temp_pub <- ggplot(means, aes(x = Temp_Treatment, y = Mean_Temp_C, color=pH_Treatment)) +
  geom_point(size = 2) +
  geom_errorbar(
    aes(ymin = Mean_Temp_C - SD_Temp_C, ymax = Mean_Temp_C + SD_Temp_C, color = as.numeric(Temp_Treatment)),
    width = 0.1,
    size = 0.75
  ) +
  scale_color_manual(values = c("darkorange", "cyan3")) +
 # scale_x_continuous(breaks = seq(12, 26, by = 2), limits = c(10, 28)) +
 # scale_y_continuous(breaks = seq(12, 26, by = 2), limits = c(10, 29)) +
 # geom_hline(data = hline_data, aes(yintercept = yintercept, color = as.numeric(Temp_Treatment)), linetype = "dashed") +
  labs(x = "Temperature Treatment", y = "Mean Temp (°C)", color = "Temp (°C)") +
  theme_classic() +
  theme(
    text = element_text(family = "Times New Roman", size = 12),
    axis.title = element_text(size = 12),
    legend.position = "right"
  )

plot(mesocosm_plot_temp_pub)

```

```{r}

# Reading in mesocosm treatment metadata
mesocosm.metadata <- read_csv(here("Data", "Mesocosm_Data", "Mesocosm_Metadata.csv"))

# dplyr::selecting all files from the folders
files <- list.files(here("Data", "Mesocosm_Data", "Mesocosm_HOBO_Temperature"),
                    pattern = ".csv", full.names = TRUE) %>% 
  sort(decreasing = TRUE) # Files ordered by decreasing values

# Reading in temperature data
temp.data <- files %>%  # Read CSV files into one data frame
  set_names(files) %>%  # Set names of columns based on file names
  map_dfr(~ read_csv(.x, skip = 4, col_names = c("Date", "Temp"), col_types = list(col_character(), col_double())), .id = "filename") %>% # Skip metadata
  mutate(
    Tank_ID = str_extract(filename, pattern = regex("TNK-[0-9]+|TNK-[A-Z]{3}")), # String extract 
    Tank_ID = str_replace(Tank_ID, pattern = "-", replacement = "_"), # Replace pattern 
    Date = ymd_hms(Date), # Change to date format
    Time = hms(format(Date, format = "%H:%M:%S")) # Separate date and time columns 
  ) %>%  
  dplyr::select(Tank_ID, Date, Time, Temp) # dplyr::selecting columns

#cleaning and filtering data
temp.clean <- temp.data %>% 
  mutate(Tide = ifelse(Time > hms("12:00:00") & Time < hms("18:00:00") | 
                       Time > hms("00:00:00") & Time < hms("06:00:00"),
                       "Low","High")) %>% # tide columns
  filter(Date >= "2022-08-16",
         Date <= "2022-09-02") %>% #filtering for length of the experiment
  group_by(Tank_ID) %>% #group by Tank_ID
  na.omit() %>% 
  left_join(mesocosm.metadata)

logger.temp.plot <- ggplot(temp.clean, aes(x = Date, y = Temp)) +
  geom_point(aes(color = Tide), na.rm = TRUE) +
  geom_hline(aes(yintercept = Temp_Treatment)) +
  facet_wrap(~Tank_ID) +
  scale_color_discrete(name = "Tank") +
  scale_y_continuous(breaks = seq(12, 36, by = 4)) +
  labs(
    title = "Mesocosm Temperature Range",
    x = "Date",
    y = "Temperature (°C)"
  ) +
  theme_minimal() +
  theme(
    text = element_text(family = "Helvetica", size = 10, color = "black"),
    legend.title = element_text(size = 10),
    plot.title = element_text(face = "bold", hjust = 0.5)  # Bold and centered title
  )

# Filter for air temperature
air.temperature <- temp.clean %>%
  filter(Time > hms("13:30:00") & Time < hms("16:30:00") |
         Time > hms("01:30:00") & Time < hms("04:30:00"))

# Filter for water temperature
water.temperature <- temp.clean %>%
  filter(Time > hms("07:30:00") & Time < hms("11:30:00") |
         Time > hms("19:30:00") & Time < hms("23:30:00"))

# Create the air temperature plot
air.temp.plot <- ggplot(air.temperature, aes(x = Date, y = Temp, color = Tide)) +
  geom_point() +
  facet_wrap(~Tank_ID) +
  theme_minimal() +
  theme(
    text = element_text(family = "Helvetica", size = 10, color = 'black'),
    legend.title = element_text(size = 12),
    plot.title = element_text(face = "bold", hjust = 0.5)  # Bold and centered title
  ) +
  scale_color_discrete(name = "Tide") +
  scale_y_continuous(breaks = seq(12, 36, by = 4)) +
  labs(title = "Air Temperature Range") +
  xlab("Date") +
  ylab("Temperature (°C)")

# Create the water temperature plot
water.temp.plot <- ggplot(water.temperature, aes(x = Date, y = Temp, color = Tide)) +
  geom_point() +
  facet_wrap(~Tank_ID) +
  theme_minimal() +
  theme(
    text = element_text(family = "Helvetica", size = 10, color = 'black'),
    legend.title = element_text(size = 12),
    plot.title = element_text(face = "bold", hjust = 0.5)  # Bold and centered title
  ) +
  scale_color_discrete(name = "Tide") +
  scale_y_continuous(breaks = seq(12, 36, by = 4)) +
  labs(title = "Water Temperature Range") +
  xlab("Date") +
  ylab("Temperature (°C)")

#Display plots
print(logger.temp.plot)
print(air.temp.plot)
print(water.temp.plot)

# Save Mesocosm HOBO logger Plots
ggsave(here("Output/logger_temp_plot.png"), logger.temp.plot, width = 8, height = 6)
ggsave(here("Output/air_temp_plot.png"), air.temp.plot, width = 8, height = 6)
ggsave(here("Output/water_temp_plot.png"), water.temp.plot, width = 8, height = 6)



```

# Mesocosm High Tide Temperatures

```{r}

# Filtering out High Tide Temperatures
high.tide.temperatures <- water.temperature %>%
  filter(Tide == 'High' & !Tank_ID %in% c("TNK_SMP", "TNK_AIR")) %>% 
  filter(Date >= "2022-08-16",
         Date <= "2022-09-02")

# Calculate the mean and standard error
high.tide.temperatures_summary <- high.tide.temperatures %>%
  group_by(Tank_ID, Temp_Treatment, pH_Treatment) %>%
  summarise(
    Mean_Temp = mean(Temp),
    SD_Temp = sd(Temp) / sqrt(n())
  ) %>%
  ungroup()


# Create the box and whisker plot
ggplot(high.tide.temperatures, aes(x = factor(Temp_Treatment), y = Temp, fill = pH_Treatment)) +
  geom_boxplot() +
  labs(
    x = "Temp Treatment",
    y = "Temperature (°C)",
    fill = "pH Treatment"
  ) +
  ggtitle("Mean Temperature in Treatment Tanks HOBO Logger") +
  scale_fill_manual(values = c("Ambient" = "orange", "Low" = "cyan3")) +  # Specify colors
  theme_minimal()

# Create the box and whisker plot without outliers
ggplot(high.tide.temperatures, aes(x = factor(Temp_Treatment), y = Temp, fill = pH_Treatment)) +
  geom_boxplot(outlier.shape = NA) +  # Remove outliers
  labs(
    x = "Temp Treatment",
    y = "Temperature (°C)",
    fill = "pH Treatment"
  ) +
  ggtitle("Mean Temperature in Treatment Tanks HOBO Logger (no outliers)") +
  scale_fill_manual(values = c("Ambient" = "orange", "Low" = "cyan3")) +  # Specify colors
  theme_minimal()

```


