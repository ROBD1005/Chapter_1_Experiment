---
title: "For Loop Respirometry"
author: "R.J. Dellinger"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(here)
library(tidyverse)
library(lubridate)
library(ggplot2)
library(LoLinR)
library(boot)
library(broom)
library(patchwork)
library(respR)
library(respirometry)
```


```{r}

#Reading in experimental treatment metadata 
experiment.metadata <- read_csv(here::here("Data", "Snail_Metadata","Experiment_Treatment_Metadata.csv"), show_col_types = FALSE)

#Reading in organism morphometric data 
snail.data <- read_csv(here::here("Data", "Snail_Metadata", "Tegula_funebralis_Morphometric_Data.csv"), show_col_types = FALSE) %>% 
  select(Snail_ID:Experiment_End_Date)

#Reading in ash free dry weight data
snail.afdw.data <- read_csv(here::here("Data", "Snail_Metadata","Tegula_funebralis_AFDW.csv"), show_col_types = FALSE)%>% 
  select(Snail_ID, Ash_Free_Dry_Weight)

#joining experimental treatment and snail data 
experiment.data <- left_join(experiment.metadata, snail.data, by = join_by(Snail_ID))

#joining data and ash free dry weight 
experiment.data <- left_join(experiment.data, snail.afdw.data, by = join_by(Snail_ID)) 

#joining data and respiration metadata 
experiment.data <- left_join(experiment.data, respo.metadata, by = join_by(Snail_ID))


```


```{r}

# Function to read a CSV file, skip the first row, skip the last few rows, and check for issues
read_and_process_csv <- function(filename, path) {
  
  # Determine the number of lines in the file and subtract 4 to skip the last few
  total_lines <- length(readLines(file.path(path, filename)))
  data_length <- total_lines - 4  # Assuming the last 4 lines are not needed
  
  # Read the CSV file, skipping the first row and the last few rows
  data <- read_csv(file.path(path, filename), skip = 1, n_max = data_length, col_names=TRUE, 
                   show_col_types = FALSE, name_repair = "unique_quiet")
  
  # Return the data without the last rows
  return(data)
}

#Set the path to the location of the raw oxygen data files
path.p <- here::here("Data","Respirometry_Data")

#renaming the file names as file.names.full
file.names <- list.files(path = path.p, pattern = "csv$", recursive = TRUE)

#creating data frame to import respiration data into 
respiration.rates <- data.frame(matrix(NA, nrow=length(file.names), ncol=6)) #setting column names
colnames(respiration.rates) <- c("File_ID","Intercept", "umolO2.L.sec","Temp.C", "Salinity", "Pressure") 

for(i in 1:length(file.names)) {
  
#Reading and processing respirometry data
Respiration_Data <- read_and_process_csv(file.names[i], path.p) %>%
    mutate(File_ID=file.names[i]) %>% # Add the file name to the data frame
    dplyr::select(File_ID, Date, Time, Value, Temp, Salinity, Pressure) %>%  # Selecting variables
    unite(Datetime, Date, Time, sep = " ") %>%  # Combine Date and Time into Datetime
    mutate(Datetime = mdy_hms(Datetime)) %>%  # Convert Datetime to POSIXct format
    drop_na()  # Drop rows with NA values

  # Getting the active file name
  Filename <- sub(".csv", "", file.names[i])
  
  # Matching file row to file name 
  Row <- which(experiment.data$File_ID == file.names[i])
  
  Start_Time <- ymd_hms(experiment.data$Respirometry_Start_Time[Row])
  Stop_Time <- ymd_hms(experiment.data$Respirometry_Stop_Time[Row])
  
  # Trimming start and stop times
  Respiration_Data <-  Respiration_Data %>%
    filter(Datetime >= Start_Time & Datetime <= Stop_Time) %>% # filter to start and stop time
    slice(120:n()) %>% # drop the first two minutes of data
    mutate(Sec = 1:n())  # create a new column for every second for the regression
  
  Respiration_Data_Unthinned <- Respiration_Data # saving original data prior to thinning
  
  Respiration_Tibble <- tibble(Time = as.numeric(), Value = as.numeric(),
                               Temp = as.numeric(), Sec = as.numeric(),
                               Salinity = as.numeric(), Pressure = as.numeric())

  Subsample <- respR::subsample(Respiration_Data, n = 15, plot=FALSE)
  Respiration_Tibble<-rbind(Respiration_Tibble, Subsample)
  
# Plotting full data     
full.plot<- ggplot(Respiration_Data_Unthinned, aes(x = Sec, y = Value)) +
    geom_point(color = "cyan3") +
    labs(x = 'Time (seconds)', y = expression(paste(' O'[2],' (',mu,'mol/L)')),
      title = "Original Data")
  
# Plotting thinned data 
thinned.plot <- ggplot(Respiration_Tibble, aes(x = Sec, y = Value))+
    geom_point(color = "cyan3")+
    labs(x = 'Time (seconds)', y = expression(paste(' O'[2],' (',mu,'mol/L)')),
      title = "Thinned Data")

# Defining the alpha value for bootstrapping
N <- nrow(Respiration_Tibble)
alpha <- 0.3  #alpha value for bootstrapping
min_n <- alpha * N

if (min_n < 15) {
  stop("Alpha is too small")
}

# Bootstrapping technique (Olito et al. 2017)
Regs <- rankLocReg(xall=Respiration_Tibble$Sec, yall=Respiration_Tibble$Value, alpha=alpha, method="pc", verbose=TRUE)  

#creates pdf of each individual respiration plot and statistics for each plot
pdf(paste0(here::here("Output","Respo_Output","Thinning_Plots"),"/", Filename ,"thinning.pdf"))
  
plot(Regs) # plot the results of the regs bootstrapping technique
plot(full.plot+thinned.plot) # use patchwork to bring the raw and thinned data together
dev.off()

# fill in all the O2 consumption and rate data
respiration.rates[i,2:3] <- Regs$allRegs[1,c(4,5)] #inserts slope and intercept in the dataframe
respiration.rates[i,1] <- paste0(Filename,".csv") #stores the file name
respiration.rates[i,4] <- mean(Respiration_Tibble$Temp, na.rm=TRUE) #stores mean temperature organisms experienced
respiration.rates[i,5] <- mean(Respiration_Tibble$Salinity, na.rm=TRUE) #stores mean salinity organisms experienced
respiration.rates[i,6] <- mean(Respiration_Tibble$Pressure, na.rm=TRUE) #stores mean pressure organisms experienced

}

#writing out data as a CSV
write_csv(respiration.rates, here("Data", "Thinned_Respirometry_Data", "Respirometry.Data.csv")) #saves to location


```


```{r}
library(measurements)
library(car)

# Reading and Merging Data 
respirometry.data.summarized <- read_csv(here("Data", "Thinned_Respirometry_Data", "Respirometry.Data.csv"), show_col_types = FALSE)
carbonate.treatment.info <- read_csv(here("Data", "Mesocosm_Data", "Completed_Mesocosm_Dataset_Carbonate.csv"), show_col_types = FALSE)
temperature.treatment.info <- read_csv(here("Data", "Mesocosm_Data", "Mesocosm_Temp_Means.csv"), show_col_types = FALSE)

# Mesocosm Biogeochemistry Data
#calculates mean_pH based on H^+ pH values, first converted to [H+] then averaged and converted back to a mean pH value 
carbonate.treatment.info <- carbonate.treatment.info %>%
  select(Tank_ID, Temp_Treatment, pH_Treatment, pH) %>% 
  group_by(Temp_Treatment, pH_Treatment) %>%
  summarize(mean_pH=respirometry::mean_pH(pH, na.rm = FALSE))

treatment.info <- left_join(carbonate.treatment.info, temperature.treatment.info, by = join_by(Temp_Treatment, pH_Treatment)) %>% 
  select(Temp_Treatment, pH_Treatment, mean_pH, Mean_Temp_C)

#Joining respiration data with the data 
joined.respo.dataset <- left_join(experiment.data, respirometry.data.summarized, by = join_by(File_ID)) %>% 
  filter(pH_Treatment != "Sump") %>% 
  select(Snail_ID, Temp_Treatment, pH_Treatment, Intercept, umolO2.L.sec, Temp.C, Salinity, Pressure, Organism_Volume_mL,
         Ash_Free_Dry_Weight, Initial_Blotted_Wet_Mass_g, Tank_ID, Identity, File_ID)

#Joining treament data with the respiration data
treatment.respo.dataset <- left_join(joined.respo.dataset, treatment.info, by = join_by(Temp_Treatment, pH_Treatment))

#Removing snails that faced mortality during the experiment
filtered.respo.dataset <- treatment.respo.dataset %>% 
  filter(Snail_ID != c("43", "36", "72")) %>% 
  na.omit()

#calculating chamber water volume by subtracting organism volume from chamber volume
respo.dataset <- filtered.respo.dataset %>%    
  # correcting for oxygen concentration at the start of the observation period (time zero) within the sealed chamber
  mutate(Volume_mL = 650-Organism_Volume_mL, #Volume of water in chamber = full chamber volume (650 mL) of water minus organism volume
         Volume_L = conv_multiunit(Volume_mL, "mL", "L"), #converting from mL to L (/1000)
         #Subtracting Initial Oxygen Content in the Chamber from Seawater (to correct for bubbles - not necessary)
         #mLO2.L = conv_o2(Intercept, from="umol_per_l", to="ml_per_l", temp=Temp.C, sal=Salinity, atm_pres=Pressure), #calculating the volume of oxygen in the chamber
         #Oxygen_Volume = Volume_L - mLO2.L, #subtracting initial oxygen content in the chamber
         #Volume_L = correct_bubble(resp_vol=Volume_L, bubble_vol=mLO2.L, temp = Temp.C, sal = Salinity, atm_pres = Pressure), #correcting the volume of water in the chamber minus the volume of oxygen
         umolO2.sec = umolO2.L.sec*Volume_L) #standardizing to umolO2/sec

# Filtering control respiration rates
respo.control.data <- respo.dataset %>%
  filter(Identity=="Control")

# Checking to see if there are differences in respiration between pH treatments and temp tratments (temp significant)
#aov_result <- aov(umolO2.sec ~ Temp_Treatment * pH_Treatment, data = respo.control.data)
#summary(aov_result)

respo.control.data <- respo.control.data %>% 
  group_by(Temp_Treatment, pH_Treatment, Identity) %>% #grouping by treatments and control identity
  summarise(umolO2.sec = mean(umolO2.sec, na.rm=TRUE)) %>% #means for blank seawater respiration 
  select(blank.rate = umolO2.sec) #selecting for only blank rates

#joining summarized control respiration data to full respiration dataset 
respo.dataset <- left_join(respo.dataset, respo.control.data)

# Conversions and normalizations for rates 
respo.rates.dataset <- respo.dataset %>% 
  mutate(
    
    # calculating uncorrected and corrected respiration rates
    #umolO2.sec.uncorrected = -(umolO2.sec),
    umolO2.sec = -(umolO2.sec - blank.rate), # subtract the blank rates from the raw rates

    # converting from umolO2/sec to umolO2/hour
    #umolO2.hr.uncorrected = (umolO2.sec.uncorrected, from="umol_O2 / sec", to="umol_O2 / hr"),
    umolO2.hr=conv_resp_unit(umolO2.sec, from="umol_O2 / sec", to="umol_O2 / hr"),

    # converting from umolO2/hr to mLO2/hr
    mL_O2.hr = conv_resp_unit(umolO2.hr, from="umol_O2 / hr", to="ml_O2 / hr"),
    uL_O2.hr =conv_multiunit(mL_O2.hr, "mL", "uL"), 
    mmolO2.hr = conv_multiunit(umolO2.hr, "umol", "mmol"), # converting from umol to mmol
    molO2.hr = conv_multiunit(umolO2.hr, "umol", "mol"), # converting from umol to mol
    
    # normalizing to ash free dry weight (grams)
    #umolO2.gram.hr.uncorrected = umolO2.hr.uncorrected / Ash_Free_Dry_Weight,
    umolO2.gram.hr = umolO2.hr / Ash_Free_Dry_Weight,
    mmolO2.gram.hr = mmolO2.hr / Ash_Free_Dry_Weight,
    molO2.gram.hr = molO2.hr / Ash_Free_Dry_Weight,
    uL_O2.gram.hr = uL_O2.hr / Ash_Free_Dry_Weight,
    uL_O2.sec = umolO2.sec / Initial_Blotted_Wet_Mass_g,
    mL_O2.gram.hr = mL_O2.hr / Ash_Free_Dry_Weight,

    # correcting for negative respiration rates and for values that fall below 0
    #uumolO2.gram.hr.uncorrected = ifelse(umolO2.gram.hr.uncorrected < 0, 0, umolO2.gram.hr.uncorrected)) %>%
    umolO2.gram.hr = ifelse(umolO2.gram.hr < 0, 0, umolO2.gram.hr),
    mL_O2.gram.hr = ifelse(mL_O2.gram.hr < 0, 0, mL_O2.gram.hr)) %>% 
  
  filter(Identity == "Treatment") %>% 
  select(-blank.rate, Snail_ID, Ash_Free_Dry_Weight, Temp_Treatment, pH_Treatment, molO2.hr, uL_O2.hr, umolO2.hr, umolO2.gram.hr, uL_O2.gram.hr, molO2.gram.hr,
         mL_O2.gram.hr, Temp.C, Salinity, Pressure, Volume_mL, Tank_ID, Mean_Temp_C, mean_pH, File_ID) 

 as_tibble(respo.rates.dataset)

write_csv(respo.rates.dataset, here("Data", "Thinned_Respirometry_Data", "Respiration.Rates.Dataset.csv"))

#Paine 1971 ~206 uL O2/g/hr @ 13.5 C ~ 413 uL O2/g/hr @ 23 C (+ or - 66 uL O2/g/hr)

```




```{r}

# Calculating Metablic Information from Respiration Rates 

ambient.pH.respo <- respo.rates.dataset %>% 
  filter(pH_Treatment == "Ambient") 

  #Calculating Q10 values for respiration rates
  Q10(R_vec=ambient.pH.respo$umolO2.gram.hr, T_vec=ambient.pH.respo$umolO2.gram.hr, model = TRUE) #larger temperature sensitivity
  
  #Calculate the metabolic scaling coefficient
  calc_b(mass=ambient.pH.respo$Ash_Free_Dry_Weight, MO2=ambient.pH.respo$umolO2.gram.hr, method = "nls", plot = "linear", b0_start = 1)

  
low.pH.respo <- respo.rates.dataset %>% 
  filter(pH_Treatment == "Low") 

  #calculating Q10 values for respiration rates
  Q10(R_vec=low.pH.respo$umolO2.gram.hr, T_vec=low.pH.respo$umolO2.gram.hr, model = TRUE) 

  #Calculate the metabolic scaling coefficient
  calc_b(mass=low.pH.respo$Ash_Free_Dry_Weight, MO2=low.pH.respo$umolO2.gram.hr, method = "nls", plot = "linear", b0_start = 1)


```




```{r}

Parameters of Q10 Temperature Coefficient
Description
Calculates parameters from Q10 temperature coefficient for chemical or biological systems. This function can be used in two ways. 1. if four of the first five parameters are given (Q10, R1, R2, T1, T2) then the fifth parameter is returned, or 2. if R_vec and T_vec are given, then the best Q10 for those data is returned.

Usage
Q10(Q10, R1, R2, T1, T2, R_vec, T_vec, model = FALSE)
Arguments
Q10	
factor by which rate changes due to 10 °C increase in temperature.

R1	
rate 1. Could also be Pcrit or any other temperature-dependent biological parameters.

R2	
rate 2. Could also be Pcrit or any other temperature-dependent biological parameters.

T1	
temperature 1 (in °C).

T2	
temperature 2 (in °C).

R_vec	
a vector of temperature-dependent values, such as rates (e.g. MO2), Pcrit or other biological parameters.

T_vec	
a vector of temperature values (in °C).

model	
logical. If TRUE, then a list is returned which includes an linear model of log10(R_vec) and T_vec fit by stats::lm(). Default is FALSE.

Details
Q_{10} = (R_2 / R_1) ^ {\frac{10}{T_2 - T_1}}


Calculate the metabolic scaling coefficient, b
Description
For most organisms, metabolic rate does not scale linearly, but rather according to a power function: MO2 = b0 * M^b. This function estimates the scaling coefficient, b, and normalization constant, b0, given MO2s from different sized individuals.

Usage
calc_b(mass, MO2, method = "nls", plot = "linear", b0_start = 1)
Arguments
mass	
a vector of animal masses.

MO2	
a vector of metabolic rates.

method	
a string defining which method of calculating scaling coefficients to use. Default is "nls", which utilizes a nonlinear least squares regression. If this does not fit your data well, "lm" may also be used, which calculates a linear regression of log10(MO2) ~ log10(mass) with slope and intercept equivalent to b and 10^b0, respectively.

plot	
a string defining what kind of plot to display. "linear" for linear axes, "log" for log10-scale axes, and "none" for no plot. Default is "linear".

b0_start	
a single numeric value as the starting point for b0 value determination using the "nls" method. The default is 1 and should work for most situations, but if the "nls" method is not working and you don't want to use the "lm" method, changing the starting b0 value may help. Ignored when method = "lm".

Details
MO2 = b0 * M^b

where b0 is species-specific normalization constant, M is mass and b is the scaling coefficient.


Usage
calc_E(x, temp)
Arguments
x	
a numeric vector of rate values (e.g. MO2) or any other values (e.g. Pcrit).
Details
E is the slope of the relationship between -ln(x) and 1/(kB T), where kB is the Boltzmann constant expressed in eV/K.

temp	
a numeric vector of temperature values (in Celsius).

------
Parameters of Q10 Temperature Coefficient
Description
Calculates parameters from Q10 temperature coefficient for chemical or biological systems. This function can be used in two ways. 1. if four of the first five parameters are given (Q10, R1, R2, T1, T2) then the fifth parameter is returned, or 2. if R_vec and T_vec are given, then the best Q10 for those data is returned.

Usage
Q10(Q10, R1, R2, T1, T2, R_vec, T_vec, model = FALSE)
Arguments
Q10	
factor by which rate changes due to 10 °C increase in temperature.

R1	
rate 1. Could also be Pcrit or any other temperature-dependent biological parameters.

R2	
rate 2. Could also be Pcrit or any other temperature-dependent biological parameters.

T1	
temperature 1 (in °C).

T2	
temperature 2 (in °C).

R_vec	
a vector of temperature-dependent values, such as rates (e.g. MO2), Pcrit or other biological parameters.

T_vec	
a vector of temperature values (in °C).

model	
logical. If TRUE, then a list is returned which includes an linear model of log10(R_vec) and T_vec fit by stats::lm(). Default is FALSE.

Q_{10} = (R_2 / R_1) ^ {\frac{10}{T_2 - T_1}}


Usage adj_by_temp( meas_temp, meas_x, temp_new, method = "Q10", Q10, E, show_coef = FALSE, plot_fit = TRUE )
Predict pH post-respiration
Description
Predicts the pH of seawater after a defined amount of oxygen consumption.

Usage
predict_pH(
  start_o2 = 100,
  end_o2,
  start_pH,
  temp = 25,
  sal = 35,
  RQ = 1,
  TA = NULL,
  all_carb = FALSE
)



# mean_pH() calculates mean pH on H^+ 
library(RespR)
RespR <- Respiration_Data_Unthinned %>% 
  mutate(time=as.numeric(Sec),
         oxygen=as.numeric(Value),
         temp=as.numeric(Temp)) %>% 
  dplyr::select(time, oxygen, temp)
  
rspR.example <- respR::subsample(RespR, n = 20) # subsample the data to 200 points

inspect(RespR)
calc_rate(RespR) 
oxy_crit(RespR)
respirometry::calc_E(temp=RespR$temp, x=RespR$oxygen)
# bg_rate <- calc_rate.bg(bg_insp) # backgrounf rate
# urch_rate_adj <- adjust_rate(urch_rate, by = bg_rate, method = "mean")
#urch_rate_adj_num <- adjust_rate(-0.0218, by = -0.000833)
# convert_rate()  can be used to convert the unitless rate values we have dealt with up to now to these reportable metrics:Conversion requires the units of the original raw data (time.unit, oxy.unit), and the volume of fluid in the respirometer in Litres (𝐿). Mass-specific rates require the mass of the specimen in kilograms (𝑘𝑔), and area-specific rates require the area of the specimen in metres squared (𝑚2). Lastly, an output.unit appropriate to the inputs should be specified. This should be in the correct order: “oxygen/time” or “oxygen/time/mass” or “oxygen/time/area”.

#convert_rate(urch_rate_adj,         # urchin rate adjusted for background
             #oxy.unit = "mg/L",     # oxygen units of the original raw data
             #time.unit = "min",     # time units of the original raw data
             #output.unit = "mg/h",  # output unit
             #volume = 1.09)         # effective volume of the respirometer
# convert_rate(urch_rate_adj, 
             #oxy.unit = "mg l-1", 
             #time.unit = "m", 
             #output.unit = "mg/s/kg",
             #volume = 1.09, 
            # mass = 0.19)
#
#
#> Oxygen Concentration or Pressure Units - Do not require t, S and P
#> [1] "mg/L"   "ug/L"   "mol/L"  "mmol/L" "umol/L" "nmol/L" "pmol/L"
#> Oxygen Concentration or Pressure Units - Require t, S and P
#>  [1] "uL/L"    "mL/L"    "mm3/L"   "cm3/L"   "cc/L"    "mg/kg"   "ug/kg"   "ppm"     "mol/kg"  "mmol/kg" "umol/kg" "nmol/kg" "pmol/kg" "uL/kg"   "mL/kg"   "%Air"    "%Oxy"    "Torr"    "hPa"     "kPa"     "mmHg"    "inHg"   
#> 
#> Volume units for use in flow rates in calc_rate.ft and convert_rate.ft
#> (e.g. as in 'ml/min', 'L/s', etc.)
#> [1] "uL" "mL" "L" 
#> 
#> Time units (for 'time.unit' or as part of 'flowrate.unit')
#> [1] "sec"  "min"  "hour" "day" 
#> 
#> Mass units
#> [1] "ug" "mg" "g"  "kg"
#> 
#> Area units
#> [1] "mm2" "cm2" "m2"  "km2"
#> 
#> 
#> #> # Metabolic Rate Units # -----------------------------
#> For use in 'convert_rate', 'convert_rate.ft', 'convert_MR'
#> 
#> Must be in correct order:
#> Absolute rates:        Oxygen/Time       e.g. 'mg/sec',     'umol/min',     'mL/h'
#> Mass-specific rates:   Oxygen/Time/Mass  e.g. 'mg/sec/ug',  'umol/min/g',   'mL/h/kg'
#> Area-specific rates:   Oxygen/Time/Area  e.g. 'mg/sec/mm2', 'umol/min/cm2', 'mL/h/m2'
#> 
#> Output Oxygen amount units
#>  [1] "ug"   "mg"   "pmol" "nmol" "umol" "mmol" "mol"  "uL"   "mL"   "mm3"  "cm3" 
#> 
#> Output Time units
#> [1] "sec"  "min"  "hour" "day" 
#> 
#> Output Mass units for mass-specific rates
#> [1] "ug" "mg" "g"  "kg"
#> 
#> Output Area units for surface area-specific rates
#> [1] "mm2" "cm2" "m2"  "km2"
#> 
#> urch_rate_final <- convert_rate(urch_rate_adj, 
                               # oxy.unit = "mg/L", 
                              #  time.unit = "mins", 
                               # output.unit = "ml/h/kg",
                              # volume = 1.09, 
                              #  mass = 0.19,
                              #  t = 20,
                              # S = 30,
                              #  P = 1.01)
#>  convert_MR() 
#> convert_MR(urch_rate_final, 
#> to = "umol/h/g",
#> t = 20,
#> S = 30,
#> P = 1.01)
```
```

